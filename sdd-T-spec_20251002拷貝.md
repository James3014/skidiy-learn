# æ»‘é›ªæ•™å­¸è©•é‡ç³»çµ± SDD-T è¦æ ¼æ›¸

## ğŸ“‹ æ–‡æª”è³‡è¨Š
- **ç‰ˆæœ¬**: T-SPEC-2.4-ABILITY â­ï¸ **æœ€æ–°ç‰ˆæœ¬**
- **å»ºç«‹æ—¥æœŸ**: 2025-10-01 09:46:33
- **æœ€è¿‘æ›´æ–°**: 2025-10-24 18:30:00
- **ä¿®æ­£åŸå› **: ç´å…¥èƒ½åŠ›çŸ©é™£ CSVã€æ•™ç·´è©•é‡èªç³»å°é½Šã€è£œä¸Š legacy å°ç…§æµç¨‹
- **åŸºæ–¼**: sdd-T-spec_20251001_094633.md (ä¿®æ­£ç‰ˆ)
- **ç‹€æ…‹**: æ­£å¼è¦æ ¼ (Latest)
- **è®Šæ›´æ‘˜è¦**:
  - ğŸ”§ ä¿®æ­£ `display_order SERIAL` â†’ `INTEGER` (Service å±¤è³¦å€¼)
  - ğŸ“ è£œå……å®Œæ•´è¡¨çµæ§‹å®šç¾© (å«æ‰€æœ‰ç´„æŸèˆ‡ç´¢å¼•)
  - ğŸ“ æ˜ç¢º Service å±¤æ’åºé‚è¼¯å¯¦ä½œ
  - ğŸ†• æ•™å­¸ç´€éŒ„å…±äº«æ¬„ä½èˆ‡ APIã€RLSã€å¯©è¨ˆç›£æ§è¦æ±‚
  - ğŸ†• ç®¡ç†å“¡å¯æ§ `can_view_shared_records` æ¬Šé™èˆ‡å…±äº«æŸ¥è©¢æµç¨‹
  - ğŸ†• åº§ä½èº«ä»½è¡¨å–® (`seat_identity_forms`) èˆ‡èªé ˜å‰é©—è­‰æµç¨‹
  - â™»ï¸ æ”¶æ–‚ `GET /lesson-records` ç‚ºå–®ä¸€ç«¯é»ï¼Œä½¿ç”¨ `scope`/`visibility` å€åˆ†ç§æœ‰èˆ‡å…±äº«æŸ¥è©¢
  - ğŸ“¦ `lesson_record_details` å†—é¤˜ `resort_id` èˆ‡æ–°ç´¢å¼•ï¼Œä»¥æ”¯æ’å…±äº«æŸ¥è©¢æ•ˆèƒ½
  - ğŸ”’ å…±äº«æˆæ¬Šé è¨­ä¿å®ˆï¼š`can_view_shared_records=FALSE`ã€è®Šæ›´éœ€ MFA + å¯©è¨ˆ + Rate Limit
  - ğŸ”— å…±äº«åª’é«”å›æ‡‰è£œå……ç°½å URL TTLï¼ˆ`expires_in`ï¼‰
  - â­ï¸ æ•™ç·´è©•é‡é åŒæ­¥é¡¯ç¤ºå­¸ç”Ÿè‡ªè©•ï¼šå¤–æ¡† 2.5px åŠ ç²—ã€é›™æ˜Ÿç­‰ Tooltipã€API `include=self_eval`
  - ğŸ¯ æ•™ç·´è©•é‡é æ–°å¢å­¸ç”Ÿé¡å‹æ¨™è¨˜ï¼ˆDoer/Thinker/Watcherï¼‰èˆ‡å¾Œç«¯å„²å­˜æ¬„ä½
  - ğŸ§­ ability_catalog æ›æˆé›™é‹å‹• 179 é …èƒ½åŠ›çŸ©é™£ï¼šæ”¯æ´ snowboard/skiã€6 å€‹ç­‰ç´šèˆ‡ CSV ç¨®å­åŒ¯å…¥

---

## ğŸ¯ 1. ç³»çµ±æ¦‚è¿°

### 1.1 ç³»çµ±å®—æ—¨
å»ºç«‹çµ±ä¸€æ»‘é›ªæ•™å­¸è©•é‡å¹³å°ï¼ŒåŒæ™‚æœå‹™ã€Œå­¸ç”Ÿèƒ½åŠ›é€²åº¦è¿½è¹¤ã€èˆ‡ã€Œæ•™ç·´æ•™å­¸éç¨‹è¨˜éŒ„ã€ã€‚

### 1.2 Linus æ ¸å¿ƒåŸå‰‡

**Good Taste (å¥½å“å‘³)**ï¼š
- æ•¸æ“šçµæ§‹æ¸…æ™°åˆ†é›¢ï¼šèƒ½åŠ›è©•é‡ (Outcome) â‰  æ•™å­¸éç¨‹ (Process)
- æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³ï¼šä¸è®“å‰ç«¯ç®¡ position é€£çºŒæ€§
- å–®ä¸€è·è²¬ï¼šæ¯å€‹è¡¨åªåšä¸€ä»¶äº‹

**Never Break Userspace (å‘å¾Œç›¸å®¹)**ï¼š
- å®Œæ•´ä¿ç•™ v4 è©•é‡è³‡æ–™å’Œ API
- èˆŠè©•é‡è¨˜éŒ„å®Œæ•´é·ç§»
- ä¸‰æ˜Ÿè©•ç­‰é«”ç³»ä¸è®Š

**Pragmatism (å¯¦ç”¨ä¸»ç¾©)**ï¼š
- è§£æ±ºçœŸå¯¦å•é¡Œï¼šæ•™ç·´å¤šèª²ç¨‹è¨˜æ†¶è² æ“”ã€å­¸ç”Ÿè·¨é›ªå ´é€²åº¦è¿½è¹¤
- é¿å…è‡†æƒ³å¨è„…ï¼šä¸è¿½è¹¤ã€Œç¹¼æ‰¿æ·±åº¦ã€åˆ° DB å±¤
- ç¹¼æ‰¿å±¤æ•¸é™åˆ¶æ”¹ç‚ºæ¥­å‹™è¦å‰‡ï¼Œå¯å‹•æ…‹èª¿æ•´

**Simplicity (ç°¡æ½”)**ï¼š
- æœ€å°å¯è¡Œæ¶æ§‹
- æ’åºç”±å¾Œç«¯çµ±ä¸€è™•ç†
- ç›£è­·äººç”¨ UUID + é‚€è«‹é€£çµï¼Œä¸ç”¨å§“å+ç”Ÿæ—¥åŒ¹é…

### 1.3 å•é¡Œå®šç¾©
- **æ•™ç·´ç—›é»**: çµ±ä¸€å¹³å°è¨˜éŒ„æ•™å­¸éç¨‹å’Œè©•é‡çµæœ
- **å­¸ç”Ÿç—›é»**: æŸ¥çœ‹å®Œæ•´å­¸ç¿’æ­·ç¨‹ï¼ˆæ•™ç·´å»ºè­°+èƒ½åŠ›é€²æ­¥ï¼‰
- **ç®¡ç†ç—›é»**: æ•´åˆå ±è¡¨å’Œçµ±ä¸€æ•¸æ“šç®¡ç†

---

## ğŸ‘¥ 2. è§’è‰²èˆ‡æ ¸å¿ƒæ—…ç¨‹

### 2.1 æ•™ç·´ (Instructor)
```
èª²ç¨‹æº–å‚™ â†’ æ•™å­¸åŸ·è¡Œ â†’ éç¨‹è¨˜éŒ„ â†’ èƒ½åŠ›è©•é‡ â†’ èª²ç¨‹ç¸½çµ
```

**é—œéµåŠŸèƒ½**:
- æŸ¥çœ‹ç•¶æ—¥èª²ç¨‹èˆ‡å¸­ä½ç‹€æ…‹
- è¨˜éŒ„æ•™å­¸åˆ†æèˆ‡ç·´ç¿’ (å¾Œç«¯è‡ªå‹•æ’åº)
- èƒ½åŠ›è©•é‡ (1-3æ˜Ÿ + è©•èª)
- ç¹¼æ‰¿å­¸ç”Ÿæœ€è¿‘è©•é‡ (ä»»ä½•æ•™ç·´)
- æ‰¹æ¬¡æ“ä½œæé«˜æ•ˆç‡

### 2.2 å­¸ç”Ÿ (Student)
```
æ”¶åˆ°é‚€è«‹ â†’ å¸­ä½èªé ˜ â†’ èª²å‰è‡ªè©• â†’ ä¸Šèª² â†’ æŸ¥çœ‹è©•é‡ â†’ è¿½è¹¤é€²åº¦
```

**é—œéµåŠŸèƒ½**:
- é‚€è«‹ç¢¼èªé ˜å¸­ä½ (8å­—å…ƒ)
- èª²å‰è‡ªè©• (å¯é¸)
- æŸ¥çœ‹æ•™ç·´è©•é‡èˆ‡å»ºè­°
- èƒ½åŠ›é€²åº¦è¶¨å‹¢åœ–
- è·¨é›ªå ´è©•é‡æ­·å²

### 2.3 ç®¡ç†å“¡ (Admin)
```
ç³»çµ±è¨­å®š â†’ èª²ç¨‹ç®¡ç† â†’ å­—å…¸ç¶­è­· â†’ å ±è¡¨æŸ¥è©¢ â†’ ç”¨æˆ¶ç®¡ç†
```

**é—œéµåŠŸèƒ½**:
- èª²ç¨‹èˆ‡å¸­ä½ç®¡ç†
- é›™é‹å‹• 179 é …èƒ½åŠ›æ¸…å–®ç¶­è­·
- æ•™ç·´å¸³è™Ÿå¯©æ ¸
- ç³»çµ±å ±è¡¨èˆ‡åŒ¯å‡º
- æ§ç®¡æ•™ç·´æ˜¯å¦å¯æª¢è¦–å…±äº«æ•™å­¸ç´€éŒ„ (`can_view_shared_records`)

### 2.4 ç›£è­·äºº (Guardian)
```
æ”¶åˆ°å­¸ç”Ÿé‚€è«‹é€£çµ â†’ ç”¨ç›£è­·äºº Email ç™»å…¥ â†’ ä»£è¡¨å­¸ç”Ÿèªé ˜ â†’ èª²å‰è‡ªè©• â†’ æŸ¥çœ‹è©•é‡
```

**ç°¡åŒ–è¨­è¨ˆ**:
- é¦–æ¬¡å»ºç«‹å­¸ç”Ÿæ™‚çµ¦ `student_uuid`
- å¾ŒçºŒç”¨ UUID + é‚€è«‹é€£çµï¼Œä¸é å§“åæ¯”å°
- ç›£è­·äººç™»å…¥å¾Œå¯åˆ‡æ›å­©å­èº«ä»½

---

## ğŸ“Š 3. User Stories (å„ªå…ˆç´šåˆ†çµ„)

### Phase 1 (P0) - MVP å¿…é ˆ

#### Epic 1: æ•™ç·´æ•™å­¸ç®¡ç†
**US-T01: èª²ç¨‹æº–å‚™**
- æŸ¥çœ‹ç•¶æ—¥èª²ç¨‹èˆ‡å¸­ä½ç‹€æ…‹
- é¡¯ç¤ºå­¸ç”Ÿä¸Šæ¬¡è©•é‡æ‘˜è¦èˆ‡è‡ªè©•ç‹€æ…‹
- **AC**: å¸­ä½ç‹€æ…‹ (pending/claimed)ã€è‡ªè©•ç‹€æ…‹ã€æ­·å²è©•é‡
- **Story Points**: 5

**US-T02: æ•™å­¸éç¨‹è¨˜éŒ„**
- è¨˜éŒ„æ•™å­¸åˆ†æèˆ‡ç·´ç¿’è¨­è¨ˆ
- ä¸Šå‚³æ•™å­¸å½±ç‰‡
- **æ”¹é€²**: å¾Œç«¯è‡ªå‹•ç¶­è­· `display_order`ï¼Œå‰ç«¯åªå‚³ ID é™£åˆ—
- **Story Points**: 8

**US-T03: èƒ½åŠ›è©•é‡**
- é›™é‹å‹• 179 é …èƒ½åŠ›æ¸…å–®è©•é‡ (1-3æ˜Ÿ + è©•èª)
- æŸ¥çœ‹å­¸ç”Ÿè‡ªè©•å°æ¯”
  - UIï¼šè‡ªè©•å¤–æ¡† 2.5px å¯¦ç·šåŠ ç²—ï¼Œæœªè‡ªè©•é¡¯ç¤º 1.5px è™›ç·š + Badgeã€Œæœªè‡ªè©•ã€
  - Tooltip åŒæ­¥é¡¯ç¤ºã€Œè‡ªè©•ï¼šâ˜…â˜†â˜†ã€ã€Œæ•™ç·´è©•åˆ†ï¼šâ˜…â˜…â˜…ã€ç­‰é›™æ˜Ÿç­‰è³‡è¨Š
- æ¨™è¨˜å­¸ç”Ÿé¡å‹ï¼ˆå¤šé¸ Chipsï¼‰ï¼šå¯¦è¸å‹ Doerã€æ€è€ƒå‹ Thinkerã€è§€å¯Ÿå‹ Watcherï¼Œé è¨­æ²¿ç”¨æœ€è¿‘ä¸€ç­†ç´€éŒ„
- æ˜Ÿç­‰èªç³»ï¼š1â˜…=ã€Œäº†è§£ (knew)ã€ã€2â˜…=ã€Œç†Ÿæ‚‰ (familiar)ã€ã€3â˜…=ã€Œç²¾ç†Ÿ (excellent)ã€ï¼Œèˆ‡æ­·å²è©•é‡ CSV (`knew/familiar/excellent`) å°é½Šä»¥åˆ©è³‡æ–™é·ç§»
- ä¸€éµç¹¼æ‰¿æœ€è¿‘è©•é‡ (è·¨æ•™ç·´)
- **AC**: `GET /coach/lessons/{id}?include=self_eval` æˆ– `GET /lessons/{id}/seats?include=self_eval` æ™‚ï¼Œå­¸ç”Ÿæ¸…å–®èˆ‡è©•é‡é éœ€å¸¶å› `self_eval`ã€`student_types` æ¬„ä½ï¼›æ•™å¸«å¯åœ¨è©•é‡é€å‡ºæ™‚æ›´æ–° `student_types`
- **æ”¹é€²**: ç§»é™¤ `inheritance_depth` DB ç´„æŸï¼Œæ”¹ç‚º Service å±¤æª¢æŸ¥
- **Story Points**: 8

**US-T05: æ•™å­¸ç¸½çµ**
- è‡ªå‹•ç”Ÿæˆæ‘˜è¦ã€å¡«å¯«å„ªé»èˆ‡å»ºè­°
- è¨­å®šè©•é‡ç‹€æ…‹ç‚ºå·²å®Œæˆ
- **Story Points**: 3

**US-T06: æ•™å­¸ç´€éŒ„å…±äº«**
- æ•™ç·´å¯é‡å°å–®ç­†/å¤šç­†ç´€éŒ„è¨­å®š `private/resort/all`
- åƒ…åœ¨å…±äº«ç‹€æ…‹èˆ‡æ•™ç·´æ¬Šé™å…è¨±ä¸‹æ‰é–‹æ”¾æŸ¥è©¢
- å…±äº«æŸ¥é–±éœ€æ”¯æ´ä¾å•é¡Œã€ç·´ç¿’ã€é›ªå ´ã€æ•™ç·´ç¯©é¸
- **Story Points**: 8

#### Epic 2: å­¸ç”Ÿå­¸ç¿’é«”é©—
**US-S01: å¸­ä½èªé ˜**
- è¼¸å…¥ 8 ä½é‚€è«‹ç¢¼èªé ˜å¸­ä½
- æˆå¹´/æœªæˆå¹´åˆ†æµè™•ç†
- **æ”¹é€²**: ç›£è­·äººç”¨ UUID é‚€è«‹é€£çµï¼Œä¸ç”¨ä¸‰æ¬„ä½åŒ¹é…
- **Story Points**: 5

**US-S03: è©•é‡çµæœæŸ¥çœ‹**
- é¡¯ç¤ºæ•™ç·´æ˜Ÿç­‰èˆ‡è©•èª
- å°æ¯”è‡ªè©•èˆ‡æ•™ç·´è©•é‡å·®ç•°
- æŸ¥çœ‹æ•™å­¸å½±ç‰‡
- **Story Points**: 5

**US-S06: èªé ˜å‰èº«ä»½å¡«å¯«**
- è¨‚èª²å¾Œæ¯å€‹åº§ä½ç”¢ç”Ÿèº«ä»½è¡¨å–®ï¼ˆå§“åã€ç”Ÿæ—¥ã€Email ç­‰ï¼‰
- ç›£è­·äººå¯é€éé‚€è«‹é€£çµè£œå¡«/ä¿®æ”¹
- èªé ˜å‰é¡¯ç¤ºæ ¸å°è³‡è¨Šï¼Œè¡¨å–®æœªå®Œæˆä¸å¯èªé ˜
- **Story Points**: 5

#### Epic 4: ç³»çµ±é·ç§»
**US-M01: v4 è³‡æ–™é·ç§»**
- é·ç§»ç”¨æˆ¶ã€èª²ç¨‹ã€è©•é‡è³‡æ–™
- å»ºç«‹å­¸ç”Ÿæ˜ å°„é—œä¿‚
- é©—è­‰è³‡æ–™å®Œæ•´æ€§
- **Story Points**: 13

**US-M02: å‘å¾Œç›¸å®¹**
- ä¿æŒæ“ä½œç¿’æ…£èˆ‡è³‡æ–™æ ¼å¼
- æ”¯æ´èˆŠé‚€è«‹æµç¨‹
- **Story Points**: 8

### Phase 2 (P1) - å¢å¼·åŠŸèƒ½

#### Epic 1: æ‰¹æ¬¡æ“ä½œ
**US-T04: æ‰¹æ¬¡è™•ç†**
- è¤‡è£½ä¸Šå ‚èª²æ•™å­¸è¨­è¨ˆ
- æ‰¹æ¬¡è¨­å®šå¤šä½å­¸ç”Ÿè©•é‡
- å¿«é€Ÿå¥—ç”¨è©•èªæ¨¡æ¿
- **Story Points**: 5

#### Epic 2: å­¸ç”Ÿè‡ªè©•èˆ‡é€²åº¦
**US-S02: èª²å‰è‡ªè©•**
- 1-3æ˜Ÿè‡ªè©• + å¯é¸è¨»è§£
- æ”¯æ´è‰ç¨¿å„²å­˜
- **Story Points**: 5

**US-S04: å­¸ç¿’é€²åº¦è¿½è¹¤**
- èƒ½åŠ›æ­·å²è®ŠåŒ–èˆ‡è¶¨å‹¢åœ–
- æŒ‰é›ªå ´/æ•™ç·´ç¯©é¸
- åŒ¯å‡º PDF å ±å‘Š
- **Story Points**: 8

#### Epic 3: ç®¡ç†ç¶­è­·
**US-A01: èª²ç¨‹ç®¡ç†**
- å»ºç«‹èª²ç¨‹ã€ç®¡ç†å¸­ä½
- é‚€è«‹ç¢¼ç”Ÿæˆèˆ‡å»¶é•·
- **Story Points**: 8

**US-A02: å­—å…¸ç¶­è­·**
- ç®¡ç†èƒ½åŠ›ã€åˆ†æã€ç·´ç¿’é …ç›®
- é›ªå ´èˆ‡é›ªé“è³‡è¨Š
- å¯©è¨ˆæ—¥èªŒ
- **Story Points**: 8

**US-A03: ç”¨æˆ¶ç®¡ç†**
- å¯©æ ¸æ•™ç·´å¸³è™Ÿ
- è§’è‰²èˆ‡æ¬Šé™è¨­å®š
- MFA ç®¡ç†
- **Story Points**: 5

**US-A04: å…±äº«æ¬Šé™ç®¡ç†**
- å¯ç‚ºå€‹åˆ¥æ•™ç·´é–‹å•Ÿ/é—œé–‰ã€ŒæŸ¥é–±å…±äº«ç´€éŒ„ã€èƒ½åŠ› (`can_view_shared_records`)
- æŸ¥çœ‹å…±äº«æ¬Šé™èª¿æ•´æ­·å²
- ä¸€éµå›æ”¶æŸæ•™ç·´æ‰€æœ‰å…±äº«é–‹é—œ
- **Story Points**: 5

### Phase 3 (P2) - åˆ†æå ±è¡¨

**US-A05: å ±è¡¨èˆ‡åˆ†æ**
- æ•™ç·´å®Œæˆç‡çµ±è¨ˆ
- å­¸ç”Ÿåƒèˆ‡ç‡åˆ†æ
- é›ªå ´ä½¿ç”¨çµ±è¨ˆ
- èƒ½åŠ›æŒæ¡åº¦åˆ‡ç‰‡ï¼šä¾ sport_type Ã— skill_level Ã— proficiency_band åŒ¯ç¸½ï¼Œå°æ‡‰ `abilitylist.csv`
- CSV/PDF åŒ¯å‡º
- **Story Points**: 8

**US-S05: èª²ç¨‹æ­·å²**
- æŒ‰æ™‚é–“åˆ—å‡ºæ‰€æœ‰èª²ç¨‹
- å¿«é€Ÿé è¦½è©•é‡èˆ‡å»ºè­°
- **Story Points**: 3

---

## ğŸ—„ï¸ 4. è³‡æ–™æ¨¡å‹ (ç°¡åŒ–ç‰ˆ)

### 4.1 æ ¸å¿ƒè¡¨ä¸€è¦½

| è¡¨å | ç”¨é€” | é—œéµæ¬„ä½ |
|------|------|----------|
| `accounts` | ç™»å…¥å¸³è™Ÿã€è§’è‰²ã€MFA | role, status, mfa_enabledï¼ˆç”±è¨‚èª²å¹³å°åŒæ­¥ï¼‰ |
| `instructors` | æ•™ç·´è³‡æ–™ | account_id, resortsï¼ˆç”±è¨‚èª²å¹³å°æä¾›ï¼‰ |
| `global_students` | å…¨åŸŸå­¸ç”Ÿèº«ä»½ | id (UUID), email, phone |
| `student_mappings` | å­¸ç”Ÿèˆ‡é›ªå ´æ˜ å°„ | global_student_id, resort_id |
| `guardian_relationships` | ç›£è­·äººé—œä¿‚ | guardian_email, student_id |
| `resorts` | é›ªå ´è³‡è¨Š | name, location |
| `lessons` | èª²ç¨‹ | resort_id, date, instructor_idï¼ˆç”±è¨‚èª²å¹³å°è¼‰å…¥ï¼‰ |
| `order_seats` | å¸­ä½ | lesson_id, seat_number, status, versionï¼ˆç”±è¨‚èª²å¹³å°è¼‰å…¥ï¼‰ |
| `seat_invitations` | é‚€è«‹ç¢¼ | code (8 chars), seat_id, expires_at |
| `seat_identity_forms` | èªé ˜å‰èº«ä»½è³‡æ–™ | seat_id, status, student_name, contact_email |
| `lesson_records` | æ•™å­¸è¨˜éŒ„ä¸»æª” | lesson_id, summary, videos |
| `lesson_record_details` | å­¸ç”Ÿæ•™å­¸è©³æƒ… | record_id, student_mapping_id, share_visibility, student_types |
| `lesson_detail_analyses` | åˆ†ææ˜ç´° | detail_id, analysis_id, display_order |
| `lesson_detail_practices` | ç·´ç¿’æ˜ç´° | detail_id, drill_id, display_order |
| `ability_catalog` | é›™é‹å‹• 179 é …èƒ½åŠ›çŸ©é™£ | name, category, sport_type, skill_level, sequence_in_level, description |
| `coach_ability_ratings` | æ•™ç·´è©•é‡ | rating (1-3), proficiency_band, comment, source_rating_id |
| `student_self_evaluations` | å­¸ç”Ÿè‡ªè©• | self_rating (1-3), self_comment |
| `legacy_id_mappings` | èˆŠç³»çµ±ç´¢å¼•å°ç…§ | legacy_type, legacy_id, new_entity_id |

`student_types` ä½¿ç”¨ `student_persona_enum[]` å„²å­˜å­¸ç”Ÿçš„å­¸ç¿’å‹æ…‹æ¨™è¨˜ï¼Œæšèˆ‰å€¼å« `doer`ï¼ˆå¯¦è¸å‹ï¼‰ã€`thinker`ï¼ˆæ€è€ƒå‹ï¼‰ã€`watcher`ï¼ˆè§€å¯Ÿå‹ï¼‰ï¼Œä»¥åˆ©æ•™ç·´è·¨èª²ç¨‹è¿½è¹¤å­¸ç”Ÿå‚¾å‘ã€‚

> è¨‚èª²å¹³å°ç‚ºå–®ä¸€ä¾†æºï¼š`accounts`ã€`instructors`ã€`lessons`ã€`order_seats` å‡ç”±è¨‚èª²ç³»çµ±åŒæ­¥æˆ–åŒ¯å…¥ï¼Œæœ¬ç³»çµ±ä¸é‡æ–°å»ºç«‹èª²ç¨‹èˆ‡å¸³è™Ÿï¼Œè€Œæ˜¯å¢è£œæ•™å­¸ç´€éŒ„ã€è©•é‡èˆ‡å…±äº«è³‡æ–™ã€‚

### 4.2 é‡è¦æ¬„ä½è¨­è¨ˆ (æ”¹é€²ç‰ˆ)

#### 4.2.1 æ’åºæ¬„ä½ç°¡åŒ– (ğŸ”§ å·²æ”¹é€²)

```sql
-- âŒ èˆŠè¨­è¨ˆï¼šå‰ç«¯ç®¡ position é€£çºŒæ€§
lesson_detail_analyses (
    position SMALLINT NOT NULL,
    UNIQUE(lesson_record_detail_id, position)
);

-- âœ… æ–°è¨­è¨ˆï¼šService å±¤è³¦å€¼æ’åº
lesson_detail_analyses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_record_detail_id UUID NOT NULL REFERENCES lesson_record_details(id) ON DELETE CASCADE,
    analysis_group_id INTEGER REFERENCES analysis_groups(id),
    analysis_id INTEGER REFERENCES analysis_items(id),
    custom_analysis TEXT,
    display_order INTEGER NOT NULL,  -- Service å±¤å¡«å…¥ 1, 2, 3...
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (analysis_id IS NOT NULL OR custom_analysis IS NOT NULL),
    UNIQUE(lesson_record_detail_id, display_order)
);

-- API ç«¯é»
POST /api/v1/lesson-records/{id}/analyses/reorder
Body: { "analysis_ids": ["uuid1", "uuid2", "uuid3"] }

-- Service å±¤å¯¦ä½œ (Python ç¯„ä¾‹)
def reorder_analyses(lesson_record_detail_id, analysis_ids):
    """é‡æ–°æ’åºåˆ†æé …ç›®ï¼Œè³¦å€¼ 1, 2, 3..."""
    with db.transaction():
        rows = db.fetch_all(
            "SELECT id FROM lesson_detail_analyses WHERE lesson_record_detail_id = %s",
            (lesson_record_detail_id,)
        )
        existing_ids = {row.id for row in rows}
        incoming_ids = set(analysis_ids)
        if incoming_ids != existing_ids:
            raise BusinessError(
                code="ANALYSIS_SET_MISMATCH",
                message="é‡æ–°æ’åºéœ€æäº¤å®Œæ•´ä¸”ä¸é‡è¤‡çš„åˆ†æé …ç›® ID"
            )
        for idx, analysis_id in enumerate(analysis_ids, start=1):
            db.execute(
                """UPDATE lesson_detail_analyses
                       SET display_order = %s, updated_at = NOW()
                       WHERE id = %s AND lesson_record_detail_id = %s""",
                (idx, analysis_id, lesson_record_detail_id)
            )

-- ç·´ç¿’æ˜ç´°è¡¨çµæ§‹ (åŒç†)
lesson_detail_practices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_record_detail_id UUID NOT NULL REFERENCES lesson_record_details(id) ON DELETE CASCADE,
    skill_id INTEGER REFERENCES skills(id),
    drill_id INTEGER REFERENCES practice_drills(id),
    custom_drill TEXT,
    practice_notes TEXT,
    display_order INTEGER NOT NULL,  -- Service å±¤å¡«å…¥ 1, 2, 3...
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (drill_id IS NOT NULL OR custom_drill IS NOT NULL),
    UNIQUE(lesson_record_detail_id, display_order)
);
```

#### 4.2.2 ability_catalog é›™é‹å‹•çŸ©é™£ï¼ˆğŸ§­ æ–°å¢ï¼‰

- **è³‡æ–™ä¾†æº**ï¼š`abilitylist.csv` å…± 179 ç­†ï¼Œå« 120 ç­† Snowboard (`type=sb`) èˆ‡ 59 ç­† Ski (`type=ski`)ï¼Œçš†ä¾ 6 å€‹ `level`ï¼ˆ1~6ï¼‰åˆ†çµ„ã€‚
- **æ¬„ä½æ˜ å°„**ï¼š
  - `sport_type` æ”¹ç”¨ `sport_type_enum ('snowboard','ski')`ï¼Œç”± CSV `type` å°æ‡‰ã€‚
  - `skill_level` æ¡ç”¨ CSV `level`ï¼ˆ1=å…¥é–€ï½6=é«˜éšï¼‰ï¼Œ`sequence_in_level` å–è‡ª `number` æ¬„ä½ä»¥ç¶­æŒå±¤å…§æ’åºã€‚
  - `description` å°æ‡‰ `explanation`ï¼Œå…è¨±ç©ºå­—ä¸²ï¼Œä½†ä¿ç•™æ¬„ä½ä»¥ä¾¿å¾ŒçºŒè£œå®Œã€‚
- **çµ±è¨ˆæ‘˜è¦**ï¼šï¼ˆç”¨æ–¼ UI grouping èˆ‡ QA æŒ‡æ¨™ï¼‰
  - Snowboardï¼šæ¯ä¸€å±¤ (1~6) çš† 20 é …ã€‚
  - Skiï¼šä¾åºç‚º 10 / 11 / 7 / 9 / 9 / 13 é …ã€‚
- **åŒ¯å…¥æ©Ÿåˆ¶**ï¼šæä¾› `catalog.seed_abilities_from_csv(path)` ç®¡ç†å·¥å…·åƒ…é™ç®¡ç†å“¡åŸ·è¡Œï¼›åŒä¸€ `sport_type + skill_level + sequence_in_level` å‡ºç¾æ™‚åŸ·è¡Œ UPSERTï¼Œç¶­è­· `updated_at`ã€‚
- **API / UI å½±éŸ¿**ï¼š
  - `GET /api/v1/catalog/abilities?sport_type=snowboard&level=3` å›å‚³ç‰¹å®šé‹å‹•èˆ‡å±¤ç´šèƒ½åŠ›ï¼Œé è¨­ä¾ `sequence_in_level` æ’åºã€‚
  - æ•™ç·´è©•é‡é èƒ½åŠ›æ¨¹éœ€ä»¥ã€Œé‹å‹•åˆ¥ â†’ å±¤ç´š â†’ èƒ½åŠ›é …ç›®ã€å±•é–‹ï¼Œå·¦å´æä¾›é—œéµå­—æœå°‹ã€‚

```sql
CREATE TYPE sport_type_enum AS ENUM ('snowboard', 'ski');

ability_catalog (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT,
    sport_type sport_type_enum NOT NULL,
    skill_level SMALLINT NOT NULL CHECK (skill_level BETWEEN 1 AND 6),
    sequence_in_level SMALLINT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (sport_type, skill_level, sequence_in_level)
);
```

#### 4.2.3 è©•é‡ç¹¼æ‰¿ç°¡åŒ– (ğŸ”§ å·²æ”¹é€²)

- `rating` ä»ç¶­æŒ 1~3 æ˜Ÿï¼Œä½†èˆ‡ `evaluationrecords_2425.csv` çš„ `knew/familiar/excellent` å°æ‡‰ï¼Œä¸¦åŒæ­¥å¯«å…¥æ–°æ¬„ä½ `proficiency_band`ï¼ˆå€¼åŸŸï¼šknew/familiar/excellentï¼‰ã€‚
- å°å…¥ `coach_proficiency_band_enum` ä»¥ä¿ç•™èªæ„ï¼ŒService å±¤å°‡ `rating=1` æ˜ å°„ `knew`ã€`rating=2` æ˜ å°„ `familiar`ã€`rating=3` æ˜ å°„ `excellent`ï¼Œç¼ºå€¼æ™‚æ‹’çµ•å¯«å…¥ã€‚

```sql
CREATE TYPE coach_proficiency_band_enum AS ENUM ('knew', 'familiar', 'excellent');

-- âŒ èˆŠè¨­è¨ˆï¼šDB å±¤ç´„æŸç¹¼æ‰¿æ·±åº¦
coach_ability_ratings (
    inheritance_depth SMALLINT DEFAULT 0 CHECK (inheritance_depth <= 2),
    inherited_from_rating_id UUID,
    inheritance_note TEXT
);

-- âœ… æ–°è¨­è¨ˆï¼šç§»é™¤ depth ç´„æŸï¼Œæ”¹ç‚º Service å±¤æª¢æŸ¥
coach_ability_ratings (
    id UUID PRIMARY KEY,
    lesson_record_detail_id UUID REFERENCES lesson_record_details(id),
    ability_id INTEGER REFERENCES ability_catalog(id),
    rating SMALLINT NOT NULL CHECK (rating BETWEEN 1 AND 3),
    proficiency_band coach_proficiency_band_enum NOT NULL,
    comment TEXT NOT NULL,
    source_rating_id UUID REFERENCES coach_ability_ratings(id), -- å–®å±¤å¼•ç”¨
    rated_by INTEGER NOT NULL REFERENCES accounts(id),
    rated_at TIMESTAMPTZ DEFAULT NOW(),
    version INTEGER DEFAULT 1,
    UNIQUE(lesson_record_detail_id, ability_id)
);

-- Service å±¤æª¢æŸ¥ (å¯é…ç½®)
MAX_INHERITANCE_DEPTH = 2  # æ¥­å‹™è¦å‰‡ï¼Œé DB ç´„æŸ

def validate_inheritance(source_rating_id):
    depth = 0
    current = source_rating_id
    seen = set()
    while current and depth < MAX_INHERITANCE_DEPTH:
        if current in seen:
            raise BusinessError(
                code="INHERITANCE_INVALID_CHAIN",
                message="ä¾†æºè©•é‡éˆå‡ºç¾å¾ªç’°ï¼Œè«‹æ”¹ç”¨æ‰‹å‹•è©•é‡"
            )
        seen.add(current)
        current = get_source_rating_id(current)
        depth += 1
    if depth >= MAX_INHERITANCE_DEPTH:
        raise BusinessError(
            code="INHERITANCE_DEPTH_EXCEEDED",
            message=f"ä¾†æºè©•é‡åƒ…å…è¨± {MAX_INHERITANCE_DEPTH} å±¤ç¹¼æ‰¿"
        )
```

#### 4.2.4 ç›£è­·äººæµç¨‹ç°¡åŒ– (ğŸ”§ å·²æ”¹é€²)

```sql
-- âŒ èˆŠè¨­è¨ˆï¼šä¸‰æ¬„ä½åŒ¹é… (ç›£è­·äººEmail, å­¸ç”Ÿå§“å, å‡ºç”Ÿå¹´)
-- å•é¡Œï¼šå¤§å°å¯«ã€trimã€æ‹¼éŸ³å·®ç•°

-- âœ… æ–°è¨­è¨ˆï¼šUUID ç‚ºä¸»
global_students (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255),
    phone VARCHAR(20),
    birth_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

guardian_relationships (
    id UUID PRIMARY KEY,
    guardian_email VARCHAR(255) NOT NULL,
    student_id UUID REFERENCES global_students(id),
    relationship_type guardian_type_enum, -- parent/guardian/relative
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(guardian_email, student_id)
);

-- é‚€è«‹æµç¨‹
-- 1. é¦–æ¬¡å»ºç«‹å­¸ç”Ÿæ™‚ç”¢ç”Ÿ UUID
-- 2. ç”¢ç”ŸçŸ­é€£çµ: /claim/{student_uuid}?token={short_code}
-- 3. ç›£è­·äººé»æ“Šé€£çµï¼Œç”¨è‡ªå·± Email ç™»å…¥
-- 4. ç³»çµ±è‡ªå‹•å»ºç«‹ guardian_relationships
-- 5. å¾ŒçºŒéƒ½ç”¨ UUIDï¼Œä¸å†æ¯”å°å§“å
-- 6. token åªå„²å­˜é›œæ¹Šå€¼ï¼Œæœ‰æ•ˆæœŸé è¨­ 7 å¤©ï¼›èªé ˜æˆåŠŸæˆ–æ’¤éŠ·ç«‹å³å¤±æ•ˆ
-- 7. åŒä¸€ç›£è­·äººå¯èªé ˜å¤šåå­¸ç”Ÿï¼Œä½† UNIQUE ç´„æŸé¿å…é‡è¤‡èªé ˜åŒä¸€å­¸ç”Ÿ
```

#### 4.2.5 èªé ˜å‰èº«ä»½è³‡æ–™ï¼ˆæ–°å¢ï¼‰

```sql
CREATE TYPE seat_identity_status_enum AS ENUM ('draft', 'submitted', 'confirmed');

CREATE TABLE seat_identity_forms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    seat_id UUID NOT NULL REFERENCES order_seats(id) ON DELETE CASCADE,
    status seat_identity_status_enum DEFAULT 'draft',
    student_display_name VARCHAR(100),
    student_english_name VARCHAR(100),
    birth_date DATE,
    contact_email VARCHAR(255),
    guardian_email VARCHAR(255),
    contact_phone VARCHAR(30),
    has_external_insurance BOOLEAN DEFAULT FALSE,
    insurance_provider VARCHAR(100),
    note TEXT,
    submitted_at TIMESTAMPTZ,
    confirmed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(seat_id)
);

CREATE INDEX idx_seat_identity_forms_status ON seat_identity_forms(status);
```

æµç¨‹ï¼š

1. **è¨‚èª²å¾Œ**ï¼šæ¯å€‹ `order_seat` è‡ªå‹•å»ºç«‹ä¸€ç­† `seat_identity_forms`ï¼ˆ`status=draft`ï¼‰ã€‚
2. **å¡«å¯«èº«ä»½è¡¨å–®**ï¼šè¨‚èª²äººæˆ–ç›£è­·äººé€éå¾Œå°ï¼é‚€è«‹é€£çµè£œé½Šå­¸ç”Ÿå§“åã€ç”Ÿæ—¥ã€Emailï¼ˆæœªæˆå¹´éœ€ç›£è­·äºº Emailï¼‰ã€‚è¡¨å–®å„²å­˜ç‚º `submitted`ã€‚
3. **ç¢ºèªèªé ˜**ï¼šç•¶ç›£è­·äººä½¿ç”¨é‚€è«‹é€£çµèªé ˜æ™‚ï¼Œç³»çµ±é¡¯ç¤ºè¡¨å–®å…§å®¹ä¾›æ ¸å°ï¼›è‹¥ç¢ºèªç„¡èª¤å³å°‡ `status` æ”¹ç‚º `confirmed`ï¼Œä¸¦å»ºç«‹/ç¶å®š `global_students` â†’ `student_mappings`ã€‚
4. **ä¿®æ”¹/æ’¤éŠ·**ï¼šè‹¥ç™¼ç¾å¡«éŒ¯ï¼Œå¯åœ¨å¾Œå°é‡è¨­è¡¨å–®ï¼ˆé‡è¨­ç‚º `draft`ï¼Œé‡æ–°å¯„é€é€£çµï¼‰ï¼Œä¸¦è¨˜éŒ„ auditã€‚
5. **ä¿éšªæ¬„ä½é¸æ“‡æ€§**ï¼š`has_external_insurance` / `insurance_provider` ç”¨æ–¼æ¨™è¨˜æ˜¯å¦ç”±å¤–éƒ¨ä¿éšªï¼Œé¿å…å‹‰å¼·è¦æ±‚ä¿éšªè³‡æ–™ã€‚

API å½±éŸ¿ï¼š
- `GET /api/v1/seats/{id}/identity-form`ï¼šå¾Œå°æŸ¥è©¢è¡¨å–®å…§å®¹ã€‚
- `PUT /api/v1/seats/{id}/identity-form`ï¼šç®¡ç†å“¡/è¨‚èª²äººæ›´æ–°è¡¨å–®ã€‚
- `POST /api/v1/invitations/{code}/identity`ï¼šå…¬é–‹ç«¯é»ï¼Œç›£è­·äººå¡«å¯«æˆ–æ›´æ–°è¡¨å–®ã€‚
- `POST /api/v1/invitations/{code}/confirm`ï¼šæœ€çµ‚èªé ˜ï¼Œéœ€æª¢æŸ¥è¡¨å–®ç‚º `submitted/confirmed` ä¸¦é¡¯ç¤ºç¢ºèªè³‡è¨Šã€‚

å¯©è¨ˆï¼šæ¯æ¬¡æ›´æ–° `seat_identity_forms` æˆ–æ”¹è®Šèªé ˜ç‹€æ…‹éƒ½éœ€å¯«å…¥ `audit_logs`ï¼ˆ`action`: `seat_identity_update`/`seat_claim_confirm`ï¼‰ã€‚

éŒ¯èª¤ç¢¼ï¼šè‹¥ `status != submitted` å»å˜—è©¦ç¢ºèªï¼Œå›å‚³ `IDENTITY_FORM_INCOMPLETE (422)`ï¼›è‹¥ `confirmed` å¾Œå†æ¬¡å¡«å¯«å‰‡é ˆå…ˆå¾©åŸã€‚

#### 4.2.6 æ•™å­¸ç´€éŒ„å…±äº«æ§åˆ¶ï¼ˆæ–°å¢ï¼‰

```sql
CREATE TYPE record_share_visibility_enum AS ENUM ('private', 'resort', 'all');
CREATE TYPE student_persona_enum AS ENUM ('doer', 'thinker', 'watcher');

lesson_record_details (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_record_id UUID NOT NULL REFERENCES lesson_records(id) ON DELETE CASCADE,
    student_mapping_id UUID NOT NULL REFERENCES student_mappings(id),
    resort_id INTEGER NOT NULL REFERENCES resorts(id),
    share_visibility record_share_visibility_enum DEFAULT 'private',
    student_types student_persona_enum[] NOT NULL DEFAULT ARRAY[]::student_persona_enum[],
    shared_at TIMESTAMPTZ,
    shared_by INTEGER REFERENCES accounts(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE instructors ADD COLUMN can_view_shared_records BOOLEAN DEFAULT FALSE;

-- é€é Trigger ç¶­è­·å†—é¤˜ resort_idï¼Œé¿å…å…±äº«æŸ¥è©¢éåº¦ JOIN
CREATE OR REPLACE FUNCTION trg_lrd_sync_resort() RETURNS trigger AS $$
BEGIN
    NEW.resort_id := (
        SELECT lr.resort_id FROM lesson_records lr WHERE lr.id = NEW.lesson_record_id
    );
    RETURN NEW;
END;$$ LANGUAGE plpgsql;

CREATE TRIGGER sync_lrd_resort
BEFORE INSERT OR UPDATE ON lesson_record_details
FOR EACH ROW EXECUTE FUNCTION trg_lrd_sync_resort();
```

å…±äº«è¦å‰‡ï¼š

- `private`: åªæœ‰æˆèª²æ•™ç·´ã€ç®¡ç†å“¡å¯è¦‹ã€‚
- `resort`: åŒä¸€ `resort_id` çš„æ•™ç·´å¯è¦‹ï¼Œå‰ææ˜¯ `can_view_shared_records = TRUE`ã€‚
- `all`: ä»»ä½•æ•™ç·´ï¼ˆå«å¤–éƒ¨ï¼‰å¯è¦‹ï¼Œä»éœ€ `can_view_shared_records = TRUE`ã€‚
- `student_types`: å„²å­˜å­¸ç”Ÿé¡å‹æ¨™è¨˜ï¼ˆ`doer`/`thinker`/`watcher`ï¼‰ï¼ŒService å±¤è‹¥æœªå¸¶å…¥å‰‡æ²¿ç”¨ä¸Šä¸€ç­†è©•é‡ç´€éŒ„ï¼Œä¾¿æ–¼è§€å¯Ÿå­¸ç¿’å‹æ…‹è®ŠåŒ–ã€‚
- `can_view_shared_records` é è¨­ `FALSE`ï¼Œåƒ…ç³»çµ±ç®¡ç†å“¡å¯èª¿æ•´ï¼›æ¯æ¬¡è®Šæ›´éœ€é€šé MFAã€æä¾›ç†ç”±ä¸¦å¯«å…¥ `audit_logs` (`action=capability_toggle`)ã€‚
- åˆ†äº«æˆ–å›æ”¶æ™‚å¿…é ˆé€é `PATCH /share-visibility`ï¼Œå¼·åˆ¶å¸¶å…¥åŸå› ä¸¦å¯«å…¥ `audit_logs`ï¼ˆ`shared_by`ã€`shared_at`ã€`reason`ï¼‰ã€‚
- å…±äº«æŸ¥è©¢ (`scope=shared`) å— 30 æ¬¡/åˆ†é˜/ä½¿ç”¨è€… Rate Limitï¼Œé€¾é™å› 429 ä¸¦è¨˜éŒ„å¤±æ•—å¯©è¨ˆã€‚

RLS å»ºè­°ï¼š

```sql
CREATE POLICY lesson_record_details_owner_policy ON lesson_record_details
USING (
    lesson_record_id IN (
        SELECT id FROM lesson_records
        WHERE instructor_id = current_setting('app.current_instructor_id')::INTEGER
    )
);

CREATE POLICY lesson_record_details_share_policy ON lesson_record_details
FOR SELECT USING (
    current_setting('app.can_view_shared_records')::BOOLEAN = TRUE
    AND (
        share_visibility = 'all'
        OR (
            share_visibility = 'resort'
            AND resort_id = current_setting('app.current_resort_id')::INTEGER
        )
    )
);
```

API è®Šæ›´ï¼š
- `PATCH /api/v1/lesson-records/{id}/share-visibility` æ›´æ–° `share_visibility`ï¼ˆåƒ…æˆèª²æ•™ç·´æˆ–ç®¡ç†å“¡ï¼Œå¿…é ˆè¨˜éŒ„ auditï¼‰ã€‚
- `GET /api/v1/lesson-records/private`ï¼šå›å‚³æ“ä½œè€…è‡ªå·±èª²ç¨‹çš„ç´€éŒ„ï¼Œå¯é¸ `include_shared=false` ä»¥æ’é™¤å…±äº«ã€‚
- `GET /api/v1/lesson-records/shared`ï¼šå›å‚³ç¬¦åˆå¯è¦‹æ¢ä»¶çš„å…±äº«ç´€éŒ„ï¼Œå¯æ­é… `visibility`ã€`analysis`ã€`tactic`ã€`resort`ã€`instructor`ã€æ™‚é–“ç¯„åœç­‰æŸ¥è©¢åƒæ•¸ã€‚

æŸ¥è©¢å„ªåŒ–ï¼š
- é‡å°å…±äº«æŸ¥è©¢æ–°å¢ç´¢å¼• `idx_lesson_record_details_visibility_resort`ï¼š
  ```sql
  CREATE INDEX idx_lesson_record_details_visibility_resort
  ON lesson_record_details(share_visibility, resort_id);
  ```
- å‰ç«¯åœ¨å…±äº«åˆ—è¡¨æä¾› `analysis`ã€`tactic`ã€`resort`ã€`instructor` ç¯©é¸ï¼Œèˆ‡èˆŠç³»çµ±ä¸€è‡´ã€‚

#### 4.2.7 å¸­ä½èªé ˜ä½µç™¼æ§åˆ¶

```sql
order_seats (
    id UUID PRIMARY KEY,
    lesson_id INTEGER REFERENCES lessons(id),
    seat_number SMALLINT CHECK (seat_number BETWEEN 1 AND 6),
    claimed_mapping_id UUID REFERENCES student_mappings(id),
    status seat_status_enum DEFAULT 'pending',
    claimed_at TIMESTAMPTZ,
    version INTEGER DEFAULT 1, -- æ¨‚è§€é–
    created_at TIMESTAMPTZ DEFAULT NOW()
);

seat_invitations (
    code VARCHAR(8) PRIMARY KEY DEFAULT SUBSTRING(gen_random_uuid()::text, 1, 8),
    seat_id UUID NOT NULL REFERENCES order_seats(id),
    expires_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '7 days',
    claimed_at TIMESTAMPTZ,
    claimed_by UUID REFERENCES student_mappings(id)
);

-- Enum å®šç¾© (é¿å…å¯¦ä½œè€…çŒœæ¸¬)
CREATE TYPE guardian_type_enum AS ENUM ('parent', 'guardian', 'relative');
CREATE TYPE seat_status_enum AS ENUM ('pending', 'invited', 'claimed', 'completed', 'expired');
```

é‚€è«‹ç¢¼ç”¢ç”Ÿéœ€å…·å‚™é‡è©¦ï¼šè‹¥ `SUBSTRING(gen_random_uuid(), 1, 8)` æ’åˆ°ç¾æœ‰ä¸»éµï¼ŒService å±¤å¿…é ˆåœ¨äº¤æ˜“å…§æœ€å¤šé‡è©¦ 5 æ¬¡ï¼Œä»å¤±æ•—å‰‡å›å‚³ `INVITE_CODE_COLLISION` æ¥­å‹™éŒ¯èª¤ä¸¦æ”¹æ¡å¾Œå‚™ç­–ç•¥ï¼ˆä¾‹å¦‚åˆ‡æ›ç‚º 12 ç¢¼ base32 äº‚æ•¸æˆ–å‘¼å« batch é ç”Ÿæ± ï¼‰ï¼Œé¿å…éœé»˜å¤±æ•—ã€‚

å…±äº«æŸ¥è©¢éœ€åŒæ™‚æª¢æŸ¥ `lesson_record_details.share_visibility` èˆ‡æ•™ç·´æ¬Šé™ `instructors.can_view_shared_records`ï¼Œä¸€æ—¦æ¬Šé™è¢«æ’¤éŠ·å³åˆ»ç¦æ­¢é–±è®€å…±äº«ç´€éŒ„ã€‚æ‰€æœ‰å…±äº«æŸ¥è©¢åŸ·è¡Œå¾Œéœ€å¯«å…¥ `audit_logs`ï¼ˆæ•™ç·´å¸³è™Ÿã€æŸ¥è©¢æ¢ä»¶ã€ç­†æ•¸ï¼‰ï¼Œä»¥åŠç›£æ§ `shared_query_count` æŒ‡æ¨™ã€‚

**å¸­ä½ç‹€æ…‹æµè½‰**
```
pending â”€(ç”¢ç”Ÿé‚€è«‹ç¢¼)â†’ invited â”€(é‚€è«‹é€¾æœŸ)â†’ expired
    â”‚                            â””â”€(æ’ç¨‹æ¸…ç†)â”˜
    â””â”€(å­¸ç”Ÿ/ç›£è­·äººèªé ˜æˆåŠŸ)â†’ claimed â”€(æ•™ç·´å®Œæˆè©•é‡)â†’ completed

- invited: å‘¼å«ç”¢ç”Ÿé‚€è«‹ç¢¼ API å¾Œè¨­å®šï¼Œé‡å¯„æ™‚æ›´æ–° `expires_at`
- expired: æ’ç¨‹ä¾ `expires_at < now()` æ›´æ–°åº§ä½ç‹€æ…‹èˆ‡å›æ”¶é‚€è«‹ç¢¼
- claimed: `order_seats` æ¨‚è§€é–æ›´æ–°æˆåŠŸå³é€²å…¥æ­¤ç‹€æ…‹
- completed: æ•™ç·´æäº¤èª²ç¨‹ç¸½çµ/è©•é‡å®Œæˆå¾Œç”±å¾Œç«¯çµ±ä¸€æ›´æ–°
```

æ’ç¨‹éœ€è¨˜éŒ„ `job_runs`ï¼ˆé–‹å§‹/çµæŸæ™‚é–“ã€è™•ç†ç­†æ•¸ã€éŒ¯èª¤è¨Šæ¯ï¼‰ï¼Œä¸¦è¼¸å‡ºè‡³å°‘å…©å€‹ç›£æ§æŒ‡æ¨™ï¼š`expired_invites_processed` èˆ‡ `job_failure`ã€‚ä»»ä¸€è¼ªå¤±æ•—éœ€è§¸ç™¼å‘Šè­¦ï¼ˆSlack/Webhookï¼‰ï¼Œä»¥å…é‚€è«‹é•·æœŸåœç•™åœ¨ `invited` ç‹€æ…‹ã€‚

#### 4.2.8 Service å±¤å¯¦ä½œåŸå‰‡ï¼ˆèªè¨€ç„¡é—œï¼‰

- **äº¤æ˜“åŸå‰‡**ï¼šä»»ä½•æœƒè®Šå‹•é †åºã€ç‹€æ…‹æˆ–ç¹¼æ‰¿éˆçš„æ“ä½œå¿…é ˆåŒ…åœ¨å–®ä¸€äº¤æ˜“å…§ï¼Œå¤±æ•—å³æ•´é«” rollbackã€‚
- **éŒ¯èª¤å°æ˜ **ï¼šå…§éƒ¨éŒ¯èª¤çµ±ä¸€æ˜ å°„ç‚ºå¸¶ code çš„ BusinessErrorï¼ˆä¾‹å¦‚ `ANALYSIS_SET_MISMATCH`, `INHERITANCE_INVALID_CHAIN`, `INVITE_CODE_COLLISION`ï¼‰ï¼ŒAPI è¿”å› 422/409 ä¸¦æä¾›ä¸­æ–‡è¨Šæ¯ã€‚
- **å¯©è¨ˆç´€éŒ„**ï¼šæ’åºã€ç¹¼æ‰¿ã€å¸­ä½èªé ˜èˆ‡æ’ç¨‹ä½œæ¥­éƒ½éœ€å¯«å…¥ `audit_logs` æˆ– `job_runs`ï¼Œä¾¿æ–¼å›æº¯ã€‚
- **é˜²å‘†æª¢æŸ¥**ï¼šæ‰€æœ‰ ID è¼¸å…¥å…ˆé©—è­‰ ownershipï¼ˆæ•™ç·´åªèƒ½å‹•è‡ªå·±èª²ç¨‹ï¼Œå­¸ç”Ÿåªèƒ½çœ‹è‡ªå·±ç´€éŒ„ï¼‰ï¼Œæœçµ•æ©«å‘è¶Šæ¬Šã€‚
- **æ“´å……æ¥å£**ï¼šæ’ç¨‹èˆ‡å¤–éƒ¨é€šçŸ¥æ¡ç”¨ Message Queue / ä»»å‹™æ¡†æ¶æŠ½è±¡ï¼Œé¿å…ç¶å®šç‰¹å®šèªè¨€å¯¦ä½œç´°ç¯€ã€‚
- **å…±äº«æŸ¥è©¢**ï¼šçµ±ä¸€å°è£ `build_shared_query(ctx)`ï¼Œå…§éƒ¨æª¢æŸ¥ `share_visibility`ã€`can_view_shared_records`ï¼Œä¸¦å°‡æŸ¥è©¢åƒæ•¸èˆ‡çµæœç­†æ•¸è¨˜éŒ„åˆ°å¯©è¨ˆèˆ‡ç›£æ§ã€‚
- **å­¸ç”Ÿé¡å‹æ¨™è¨˜**ï¼šæ›´æ–° `lesson_record_details.student_types` æ™‚éœ€æ ¡é©— enumï¼Œæœªæä¾›æ™‚æ²¿ç”¨è©²å­¸ç”Ÿæœ€è¿‘ä¸€ç­†èª²ç¨‹ç´€éŒ„ï¼›å…±äº«æŸ¥è©¢é è¨­è¿”å›å®Œæ•´æ¨™è¨˜ä¾›è·¨æ•™ç·´åƒè€ƒã€‚
- **èº«ä»½è¡¨å–®**ï¼šæä¾› `submit_identity_form`/`confirm_seat_claim` æ–¹æ³•ï¼Œé ˆé©—è­‰å¿…å¡«æ¬„ä½ï¼Œstatus ä¸ç¬¦æ™‚å›å‚³ `IDENTITY_FORM_INCOMPLETE`ï¼Œä¸¦å¯«å…¥ audit/metricsã€‚
- **Legacy å°ç…§**ï¼šç¶­è­· `legacy_id_mappings`ï¼ˆ`legacy_type` = student_idx / lesson_idx / ability_idxï¼‰ï¼Œä¾› `evaluationrecords_2425.csv` é·ç§»èˆ‡å¾ŒçºŒè¿½è¹¤ï¼›Service å±¤å–å¾—æˆ–å»ºç«‹å°ç…§å¾Œæ–¹å¯å¯«å…¥æ­£å¼è¡¨æ ¼ã€‚

### 4.3 ç´¢å¼•ç­–ç•¥

```sql
-- è©•é‡æŸ¥è©¢å„ªåŒ–
CREATE INDEX idx_coach_ratings_student_lesson
ON coach_ability_ratings(lesson_record_detail_id, ability_id);

CREATE INDEX idx_coach_ratings_source
ON coach_ability_ratings(source_rating_id)
WHERE source_rating_id IS NOT NULL;

-- èƒ½åŠ›ç›®éŒ„æŸ¥è©¢
CREATE INDEX idx_ability_catalog_sport_level
ON ability_catalog(sport_type, skill_level, sequence_in_level);

-- è‡ªè©•æŸ¥è©¢
CREATE INDEX idx_self_eval_student_lesson
ON student_self_evaluations(student_mapping_id, lesson_id);

-- å­¸ç”Ÿé¡å‹æŸ¥è©¢
CREATE INDEX idx_lesson_record_details_student_types
ON lesson_record_details USING GIN (student_types);

-- å­¸ç”Ÿæ˜ å°„
CREATE INDEX idx_student_mappings_global
ON student_mappings(global_student_id);

-- é‚€è«‹ç¢¼å¿«é€Ÿé©—è­‰
CREATE INDEX idx_seat_invitations_code
ON seat_invitations(code, expires_at)
WHERE claimed_at IS NULL;

-- æ’åºæŸ¥è©¢
CREATE INDEX idx_analyses_display_order
ON lesson_detail_analyses(lesson_record_detail_id, display_order);
```

---

## ğŸ”Œ 5. API è¨­è¨ˆ (ç°¡åŒ–ç‰ˆ)

### 5.1 èªè­‰èˆ‡å¸³è™Ÿ
```
POST   /api/v1/auth/login           # Email+å¯†ç¢¼ï¼Œè¿”å› JWT
POST   /api/v1/auth/refresh         # åˆ·æ–° Token
GET    /api/v1/me                   # ç•¶å‰ç”¨æˆ¶è³‡è¨Š
POST   /api/v1/accounts             # Admin: å»ºç«‹å¸³è™Ÿ
```

### 5.2 èª²ç¨‹èˆ‡å¸­ä½ (ğŸ”§ å·²æ”¹é€²)
```
GET    /api/v1/lessons?role=coach&date=    # èª²ç¨‹æ¸…å–®
POST   /api/v1/lessons                     # å»ºç«‹èª²ç¨‹
GET    /api/v1/lessons/{id}/seats?include=self_eval
                                                 # å¸­ä½ç‹€æ…‹ + (é¸ç”¨) å­¸ç”Ÿè‡ªè©•æ˜Ÿç­‰èˆ‡è©•è«–æ‘˜è¦
POST   /api/v1/seats/{id}/invitations      # ç”¢ç”Ÿé‚€è«‹ç¢¼
POST   /api/v1/invitations/claim           # èªé ˜å¸­ä½ (æ¨‚è§€é–)

# ğŸ†• ç›£è­·äººé‚€è«‹ (ç°¡åŒ–)
GET    /api/v1/invite/student/{student_uuid}?token={code}
       # ç›£è­·äººé»æ“Šé€£çµï¼Œè‡ªå‹•å»ºç«‹é—œä¿‚
GET    /api/v1/seats/{id}/identity-form         # å¾Œå°ï¼šæŸ¥çœ‹èº«ä»½è¡¨å–®
PUT    /api/v1/seats/{id}/identity-form         # å¾Œå°ï¼šæ›´æ–°èº«ä»½è¡¨å–®
POST   /api/v1/invitations/{code}/identity      # å…¬é–‹ï¼šå¡«å¯«/æ›´æ–°èº«ä»½è¡¨å–®
POST   /api/v1/invitations/{code}/confirm       # å…¬é–‹ï¼šç¢ºèªèªé ˜ä¸¦ç¶å®šå­¸ç”Ÿ
```

### 5.3 æ•™ç·´æ•™å­¸è¨˜éŒ„ (ğŸ”§ å·²æ”¹é€²)
```
GET    /api/v1/coach/lessons/{id}?include=self_eval  # èª²ç¨‹æ¦‚æ³ + å­¸ç”Ÿè‡ªè©•æ¬„ä½
GET    /api/v1/students/{mapping_id}/latest-ratings  # æœ€è¿‘è©•é‡ (ç¹¼æ‰¿ç”¨)
POST   /api/v1/lesson-records                        # å»ºç«‹æ•™å­¸è¨˜éŒ„
POST   /api/v1/lesson-records/{id}/ratings           # æ‰¹æ¬¡è©•é‡
       # Request body è£¡çš„æ¯å€‹ student_detail æ”¯æ´ `student_types: ["doer","thinker"]`ï¼ˆå¤šé¸ï¼Œæ²¿ç”¨ä¸Šæ¬¡ç´€éŒ„ç‚ºé è¨­ï¼‰

# ğŸ†• æ’åº API (ç°¡åŒ–)
POST   /api/v1/lesson-records/{id}/analyses/reorder
Body:  { "analysis_ids": ["uuid1", "uuid2", "uuid3"] }
       # å¾Œç«¯è‡ªå‹•è¨­å®š display_order = 1, 2, 3

POST   /api/v1/lesson-records/{id}/practices/reorder
Body:  { "practice_ids": ["uuid1", "uuid2", "uuid3"] }

PATCH  /api/v1/lesson-records/{id}/share-visibility
Body:  { "detail_id": "uuid", "share_visibility": "private|resort|all", "reason": "æ–‡å­—" }
       # å¿…é ˆé™„ä¸Š `X-MFA-Token` + `X-Idempotency-Key`ï¼Œå¯«å…¥ audit_logs (shared_by/shared_at/reason)

GET    /api/v1/lesson-records
Params:
  scope=private|shared (default=private)
  visibility=private|resort|all ï¼ˆåƒ… scope=shared ç”Ÿæ•ˆï¼Œä¸” shared æ™‚å¿…å¡«ï¼‰
  include_shared=true|false ï¼ˆåƒ… scope=privateï¼›é è¨­ trueï¼Œfalse æ™‚æ’é™¤å·²åˆ†äº«ç´€éŒ„ï¼‰
  analysis=ID / tactic=ID / resort=ID / instructor=ID
  q=keyword, sort=created_at:desc
  page=1, page_size=20ï¼ˆæœ€å¤§ 100ï¼‰
Notes:
- scope=shared éœ€è¦ `can_view_shared_records=TRUE`ï¼Œä¸¦å— 30 æ¬¡/åˆ†é˜/ä½¿ç”¨è€…ç¯€æµã€‚
- å›æ‡‰ä¾ scope è‡ªå‹•è„«æ•ï¼›å…±äº«çµæœå›å‚³ç°½å URL èˆ‡ `expires_in` (ç§’)ã€‚
- æ¯æ¬¡æŸ¥è©¢å¯«å…¥ `audit_logs`ï¼Œ`scope=shared` å¦è¨˜éŒ„çµæœç­†æ•¸ã€filtersã€‚
- `include=self_eval` åŒæ™‚è¼‰å…¥ `self_eval` èˆ‡ `student_types` æ¬„ä½ï¼Œä¾›æ•™ç·´æ¯”å°è‡ªè©•å·®ç•°èˆ‡å­¸ç”Ÿé¡å‹æ¨™è¨˜ã€‚

`scope=shared` Response:
```json
{
  "data": [
    {
      "detail_id": "uuid",
      "lesson_id": "uuid",
      "lesson_date": "2025-02-18",
      "instructor_name": "æ—æ•™ç·´",
      "resort": "è‹—å ´ (Naeba)",
      "share_visibility": "resort",
      "analysis": {
        "category": "ç«™å§¿èˆ‡å¹³è¡¡",
        "analysis": "é‡å¿ƒåœ¨å‰è…³",
        "analysis_desc": "é‡å¿ƒå¤ªå‰è…³å°è‡´æ¿å°¾æ»‘é–‹"
      },
      "tactic": {
        "skill": "æ©«å‘é‹å‹•-ç«‹åˆƒ",
        "tactic": "æ»‘è¡Œé‡å¿ƒè½‰ç§»",
        "tactic_desc": "å˜—è©¦è½‰å½æ™‚å‰å¾Œé‡å¿ƒåˆ‡æ›"
      },
      "feedback": {
        "summary": "æ­£é¢å›é¥‹èˆ‡å»ºè­°çš„è„«æ•æ‘˜è¦",
        "link_before": "https://signed/...",
        "link_after": "https://signed/..."
      },
      "media_ttl": 86400,
      "shared_at": "2025-02-18T05:30:00Z",
      "shared_by": "UUID"
    }
  ],
  "meta": {
    "scope": "shared",
    "visibility": "resort",
    "filters": {
      "analysis": "é‡å¿ƒåœ¨å‰è…³",
      "tactic": null
    },
    "page": 1,
    "page_size": 20,
    "count": 12,
    "expires_in": 86400
  }
}
```

`scope=private` Response:
```json
{
  "data": [
    {
      "detail_id": "uuid",
      "lesson_id": "uuid",
      "lesson_date": "2025-02-18",
      "resort": "è‹—å ´ (Naeba)",
      "course": "A1 å¤§æ–œé¢",
      "analysis": {
        "category": "ç«™å§¿èˆ‡å¹³è¡¡",
        "analysis": "é‡å¿ƒåœ¨å‰è…³",
        "analysis_desc": "é‡å¿ƒå¤ªå‰è…³å°è‡´æ¿å°¾æ»‘é–‹"
      },
      "tactic": {
        "skill": "æ©«å‘é‹å‹•-ç«‹åˆƒ",
        "tactic": "æ»‘è¡Œé‡å¿ƒè½‰ç§»",
        "tactic_desc": "å˜—è©¦è½‰å½æ™‚å‰å¾Œé‡å¿ƒåˆ‡æ›"
      },
      "feedback": {
        "positive": "åŸºæœ¬ç«™å§¿è‰¯å¥½",
        "try": "ç·´ç¿’æµ·è±šå¼è½‰å½",
        "comment": "å®Œæ•´è©•èªèˆ‡æ³¨æ„äº‹é …",
        "link_before": "https://signed/...",
        "link_after": "https://signed/..."
      },
      "share_visibility": "private"
    }
  ],
  "meta": {
    "scope": "private",
    "include_shared": true,
    "page": 1,
    "page_size": 20,
    "count": 5
  }
}
```

éš±ç§è¦æ±‚ï¼š
- å…±äº«å›æ‡‰ä¸å¾—åŒ…å«å­¸ç”Ÿå§“åã€Emailã€é›»è©±ç­‰å€‹è³‡ã€‚
- `link_before/link_after` çš†ä½¿ç”¨ç°½å URLï¼Œé è¨­ TTL=24hï¼Œå¯é€é Feature Flag åˆ‡æ› 12h/72hï¼›åˆ°æœŸå¼·åˆ¶å› 403ã€‚
- `feedback.summary` ç‚ºè„«æ•å¾Œçš„å»ºè­°æ‘˜è¦ï¼Œå®Œæ•´æ–‡å­—åƒ…é™åŸæ•™ç·´æˆ–ç®¡ç†å“¡åœ¨ scope=private æ™‚å­˜å–ã€‚

å®‰å…¨ï¼š
- scope=private å›æ‡‰å¯åŒ…å«å®Œæ•´æ•™ç·´å›é¥‹èˆ‡å½±ç‰‡é€£çµï¼Œä½†åƒ…é™åŸæ•™ç·´æˆ–ç®¡ç†å“¡æŸ¥çœ‹ã€‚
- API å¿…é ˆä½¿ç”¨ JWT å…§çš„æ•™ç·´ ID é©—è­‰å‘¼å«è€…èº«åˆ†ï¼Œç¦æ­¢å…¶å®ƒæ•™ç·´æˆ–å¤–éƒ¨ä½¿ç”¨è€…å­˜å–ã€‚
- æ‰€æœ‰æŸ¥è©¢éœ€å¯«å…¥å¯©è¨ˆï¼ˆ`action=lesson_lookup`ï¼Œä¸¦æ¨™ç¤º scope/filtersï¼‰ã€‚
```

### 5.4 å­¸ç”Ÿè‡ªè©•èˆ‡é€²åº¦
```
POST   /api/v1/students/me/self-evaluations       # æäº¤è‡ªè©•
GET    /api/v1/students/me/progress                # æ­·å²è©•é‡èˆ‡è¶¨å‹¢
GET    /api/v1/students/me/lessons/{id}           # èª²ç¨‹è©³æƒ…
POST   /api/v1/students/me/identity/merge         # åˆä½µé‡è¤‡èº«ä»½
```

### 5.5 å­—å…¸ç¶­è­·
```
GET/POST/PATCH /api/v1/catalog/abilities           # èƒ½åŠ›æ¸…å–®ï¼ˆGET æ”¯æ´ query: sport_type, level, keywordï¼‰
GET/POST/PATCH /api/v1/catalog/analysis-groups     # åˆ†æé …ç›®
GET/POST/PATCH /api/v1/catalog/practice-drills     # ç·´ç¿’é …ç›®
GET/POST       /api/v1/templates/summary           # è©•èªæ¨¡æ¿
```

### 5.5.1 æ¸¬è©¦èˆ‡ç›£æ§å‚™è¨»
- å…±äº«/ç§æœ‰ API éœ€è¦†è“‹ä»¥ä¸‹æ¸¬è©¦æ¡ˆä¾‹ï¼š
  1. ç„¡æ¬Šé™æ•™ç·´æŸ¥è©¢å…±äº« => 403
  2. `include_private` å°éæ“æœ‰è€… => ç©ºçµæœ
  3. ä¸åŒ `visibility` çµ„åˆ (resort/all)
  4. å¯©è¨ˆèˆ‡ metrics å¯«å…¥æˆåŠŸï¼ˆmock æˆ–æª¢æŸ¥ logï¼‰
- ç›£æ§æŒ‡æ¨™ï¼š`shared_query_count` (by coach_id, visibility)ã€`private_query_count`ã€`shared_query_failure`ã€‚
- Audit log æ¨™æº–æ¬„ä½ï¼š`actor_id`, `action`, `filters`, `count`, `performed_at`.

### 5.6 éŒ¯èª¤ç¢¼

```json
{
  "success": false,
  "error": {
    "code": "SEAT_CLAIMED",
    "message": "å¸­ä½å·²è¢«èªé ˜",
    "details": {
      "claimed_at": "2025-09-30T12:00:00Z",
      "claimed_by": "ç‹å°æ˜"
    }
  }
}
```

**æ¨™æº–éŒ¯èª¤ç¢¼**:
- `VALIDATION_ERROR` (400)
- `UNAUTHORIZED` (401)
- `FORBIDDEN` (403)
- `NOT_FOUND` (404)
- `CONFLICT` (409) - version ä¸ç¬¦
- `SEAT_CLAIMED` (423) - å¸­ä½å·²è¢«èªé ˜
- `INVITE_EXPIRED` (410) - é‚€è«‹ç¢¼éæœŸ
- `ANALYSIS_SET_MISMATCH` (422) - é‡æ–°æ’åº ID ä¸å®Œæ•´æˆ–é‡è¤‡
- `INHERITANCE_INVALID_CHAIN` (422) - ä¾†æºè©•é‡éˆå¾ªç’°æˆ–ä¸å­˜åœ¨
- `INHERITANCE_DEPTH_EXCEEDED` (422) - è¶…éå…è¨±çš„ç¹¼æ‰¿å±¤æ•¸
- `INVITE_CODE_COLLISION` (409) - çŸ­ç¢¼ç”¢ç”Ÿå¤šæ¬¡ç¢°æ’ï¼Œéœ€ç¨å€™å†è©¦
- `INVALID_VISIBILITY` (422) - éæ³•å…±äº«ç‹€æ…‹
- `IDENTITY_FORM_INCOMPLETE` (422) - èªé ˜å‰èº«ä»½è³‡æ–™å°šæœªå®Œæˆ
- `ONLY_OWNER_CAN_SHARE` (403) - éæˆèª²æ•™ç·´è©¦åœ–ä¿®æ”¹å…±äº«è¨­å®š
- `RATE_LIMITED` (429)

---

## ğŸ¨ 6. å‰ç«¯è¨­è¨ˆé‡é»

### 6.1 æ•™ç·´å·¥ä½œå€
- **å„€è¡¨æ¿**: ä»Šæ—¥èª²ç¨‹ã€å¸­ä½ç‹€æ…‹ã€æœªå®Œæˆè©•é‡æé†’
- **èª²ç¨‹é **:
  - å·¦å´å­¸ç”Ÿæ¸…å–®: é‚€è«‹ç‹€æ…‹ã€è‡ªè©•ã€æœ€è¿‘è©•é‡æ‘˜è¦
  - å³å´è¡¨å–®: åˆ†é åˆ‡æ›ã€Œæ•™å­¸éç¨‹ã€ã€Œèƒ½åŠ›è©•é‡ã€
  - èƒ½åŠ›è©•é‡é ï¼šè‡ªè©•æ˜Ÿç­‰ä»¥ 2.5px å¯¦ç·šå¤–æ¡†å‘ˆç¾ï¼ˆæœªè‡ªè©•æ”¹ 1.5px è™›ç·š + Badgeã€Œæœªè‡ªè©•ã€ï¼‰ï¼Œæ•™ç·´æ˜Ÿç­‰ç‚ºå¯æ“ä½œå¯¦å¿ƒå¡«æ»¿ï¼›Hover/Focus Tooltip é¡¯ç¤ºé›™æ˜Ÿç­‰ï¼ˆä¾‹ï¼šè‡ªè©•ï¼šâ˜…â˜†â˜†ï½œæ•™ç·´ï¼šâ˜…â˜…â˜…ï¼‰
  - å­¸ç”Ÿé¡å‹å€å¡Šï¼šDoer/Thinker/Watcher ä»¥è† å›Š Chip å‘ˆç¾ï¼Œæ”¯æ´å¤šé¸ã€éµç›¤åˆ‡æ›èˆ‡é è¨­å¸¶å…¥ä¸Šä¸€ç­†ç´€éŒ„
  - èƒ½åŠ›æ¸…å–®ï¼šä¾ sport_typeï¼ˆsnowboard/skiï¼‰â†’ skill_levelï¼ˆ1~6ï¼‰â†’ é …ç›®æ’åºå‘ˆç¾ï¼Œæ”¯æ´é—œéµå­—å¿«é€Ÿæœå°‹èˆ‡ CSV ç¨®å­åŒæ­¥ç‹€æ…‹æç¤º
  - **æ’åºæ”¹é€²**: æ‹–æ‹‰æ’åºå¾Œåªå‚³ `analysis_ids` é™£åˆ—
- **æ­·å²é **: ä¾å­¸ç”Ÿæˆ–èª²ç¨‹æŸ¥è©¢
- **å…±äº«ä¸­å¿ƒ**: æä¾› `private/resort/all` é–‹é—œã€å•é¡Œ/ç·´ç¿’/é›ªå ´/æ•™ç·´/æ—¥æœŸç¯©é¸ã€å…±äº«åˆ—è¡¨ï¼ˆé¡¯ç¤ºæ•™ç·´ã€é›ªå ´ã€å…±äº«æ™‚é–“ã€å›é¥‹æ‘˜è¦ï¼‰ï¼Œæ”¯æ´æ‰¹æ¬¡åˆ†äº«èˆ‡å›æ”¶ä¸¦é¡¯ç¤ºå¯©è¨ˆæç¤º

### 6.2 å­¸ç”Ÿå°ˆå€
- **èª²ç¨‹åˆ—è¡¨**: æœ€è¿‘èª²ç¨‹ã€å³å°‡åˆ°ä¾†ã€è‡ªè©•å…¥å£
- **èª²ç¨‹è©³æƒ…**: æ˜Ÿç­‰ã€è‡ªè©•å·®ç•°ã€å»ºè­°ã€å½±ç‰‡
- **èƒ½åŠ›è¶¨å‹¢åœ–**: æŠ˜ç·šåœ–é¡¯ç¤ºæ˜Ÿç­‰æ­·å²

### 6.3 ç®¡ç†å¾Œå°
- **å­—å…¸ç¶­è­·**: åˆ—è¡¨ + å³å´ç·¨è¼¯ã€æ‰¹æ¬¡åŒ¯å…¥
- **å¸­ä½ç›£æ§**: é‚€è«‹ç‹€æ…‹ã€é€¾æœŸæé†’ã€é‡å¯„é‚€è«‹
- **å ±è¡¨**: æ•™ç·´ç¸¾æ•ˆã€é›ªå ´çµ±è¨ˆã€åŒ¯å‡º

---

## ğŸ”’ 7. å®‰å…¨ã€éš±ç§èˆ‡æ•ˆèƒ½

### 7.1 å®‰å…¨
- **JWT**: Access (15 mins) + Refresh (7 days)
- **MFA**: æ•æ„Ÿæ“ä½œéœ€é©—è­‰ï¼ˆå…±äº«å¯è¦‹æ€§æ›´æ–°ã€èƒ½åŠ›æ——æ¨™èª¿æ•´ã€æ‰¹æ¬¡åŒ¯å‡ºã€å¸­ä½èªé ˜ç¢ºèªï¼‰
- **Rate Limit**: ç™»å…¥ 5 æ¬¡/åˆ†é˜/IPï¼›å…±äº«æŸ¥è©¢ 30 æ¬¡/åˆ†é˜/ä½¿ç”¨è€…ï¼ˆscope=sharedï¼‰ï¼Œé€¾é™å› 429 ä¸¦å¯«å…¥å¯©è¨ˆ
- **RLS**: PostgreSQL Row Level Security
  - æ•™ç·´åƒ…å­˜å–æˆèª²è³‡æ–™
  - å­¸ç”Ÿåƒ…å­˜å–è‡ªèº«è¨˜éŒ„
  - ç›£è­·äººåƒ…å­˜å–å…è¨±çš„å­¸ç”Ÿ
  - å…±äº«ç´€éŒ„éœ€åŒæ™‚æª¢æŸ¥ `share_visibility` èˆ‡ `can_view_shared_records`
- **å¯©è¨ˆ**: æ‰€æœ‰å¯«æ“ä½œè¨˜éŒ„ `audit_logs`ï¼Œå…±äº«æŸ¥è©¢èˆ‡æ——æ¨™èª¿æ•´å¿…é ˆé™„å¸¶ç†ç”±èˆ‡æ“ä½œè€…è³‡è¨Š

### 7.2 éš±ç§
- **å‚³è¼¸**: TLS 1.3
- **éœæ…‹åŠ å¯†**: AES-256 (å­¸ç”Ÿè¯çµ¡æ–¹å¼ã€åº§ä½èº«ä»½è¡¨å–®)
- **å‚™ä»½**: WAL + S3 (ä¿ç•™ 30 å¤©)
- **èº«ä»½è¡¨å–®**: èªé ˜å®Œæˆå¾Œåƒ…ä¿ç•™å¿…è¦æ¬„ä½ï¼ˆå§“åã€ç”Ÿæ—¥ã€Emailï¼‰ï¼Œä¿éšª/å‚™è¨»å¯åŒ¿ååŒ–æˆ–å®šæœŸæ¸…é™¤
- **æ³•è¦éµå¾ª**: GDPR/å€‹è³‡æ³•

### 7.3 æ•ˆèƒ½ SLO
- API P95 < 400ms
- åŒæ™‚åœ¨ç·š 500 ç”¨æˆ¶
- è³‡æ–™å‚™ä»½ RTO < 4h, RPO < 1h
- Read Replica æœå‹™å ±è¡¨æŸ¥è©¢

---

## ğŸš€ 8. è³‡æ–™é·ç§»è¨ˆç•«

### 8.1 é·ç§»æ­¥é©Ÿ
1. **v4 è³‡æ–™åŒ¯å…¥**:
   - `resorts`, `users`, `lessons`, `order_seats`
   - `abilitylist.csv` â†’ `ability_catalog`ï¼ˆä¾ `sport_type`ã€`skill_level`ã€`sequence_in_level` åˆ†çµ„ UPSERTï¼‰
   - `evaluationrecords_2425.csv` â†’ è½‰æ›ç‚º `coach_ability_ratings`ï¼ˆæ‹†è§£ `knew/familiar/excellent` è‡³ `proficiency_band`ï¼‰+ `student_self_evaluations`

2. **å­¸ç”Ÿèº«ä»½çµ±ä¸€**:
   - å»ºç«‹ `global_students` (ä»¥ email/phone å»é‡)
   - å»ºç«‹ `student_mappings` é€£çµé›ªå ´

3. **å°ç…§è¡¨å»ºç«‹**:
   - èˆŠç³»çµ± ID â†’ æ–°ç³»çµ± UUID æ˜ å°„ï¼ˆå« `studentIdx`ã€`lessonIdx`ï¼‰
   - èƒ½åŠ›ä»£ç¢¼ä¸€è‡´æ€§é©—è­‰ï¼ˆç¢ºä¿ CSV `idx` èˆ‡ DB `ability_catalog.id` å°é½Šï¼‰

4. **æ•´åˆæ¸¬è©¦**:
   - éš¨æ©ŸæŠ½æ¨£ 100 ç­†å­¸ç”Ÿæª¢æ ¸æ˜Ÿç­‰èˆ‡è©•èª
   - é©—è­‰å¸­ä½èªé ˜ã€è©•é‡ç¹¼æ‰¿æµç¨‹

### 8.2 å›æ»¾æ–¹æ¡ˆ
- ä¿ç•™èˆŠç³»çµ±å”¯è®€ 30 å¤©
- é·ç§»å¤±æ•—æ™‚å¾å‚™ä»½æ¢å¾©
- æä¾›ã€Œå·®ç•°å ±å‘Šã€ä¾›äººå·¥æ ¸å°

---

## âš ï¸ 9. é¢¨éšªèˆ‡ç·©è§£

| é¢¨éšª | ç·©è§£ç­–ç•¥ |
|------|----------|
| è³‡æ–™é·ç§»éŒ¯èª¤ | åˆ†æ®µé·ç§»ã€æŠ½æ¨£é©—è­‰ã€ä¿ç•™èˆŠç³»çµ± |
| æ•™ç·´/å­¸ç”Ÿç¿’æ…£æ”¹è®Š | å°è¦½å½±ç‰‡ã€Beta æ¸¬è©¦ã€æµ®å±¤èªªæ˜ |
| æ’åºé‚è¼¯ bug | å¾Œç«¯çµ±ä¸€è™•ç†ã€å–®å…ƒæ¸¬è©¦è¦†è“‹ |
| ç¹¼æ‰¿æ·±åº¦éæ·± | Service å±¤æª¢æŸ¥ã€å¯é…ç½®ä¸Šé™ |
| ç›£è­·äººèº«ä»½æ··äº‚ | UUID é‚€è«‹é€£çµã€ä¸é å§“ååŒ¹é… |
| å®‰å…¨æ§ç®¡ç–æ¼ | å•Ÿç”¨ RLSã€æ»²é€æ¸¬è©¦ã€WAF |
| å ±è¡¨æ•ˆèƒ½ | Read Replicaã€ç´¢å¼•ã€æ’ç¨‹åŒ¯å‡º |

---

## ğŸ“ 10. å¾ŒçºŒå·¥ä½œ

### Phase 1 (MVP)
- [ ] å®Œæˆ ERD èˆ‡ OpenAPI æ–‡ä»¶
- [ ] å‰ç«¯ Wireframe (Figma)
- [ ] è³‡æ–™åº«é·ç§»è…³æœ¬
- [ ] æ ¸å¿ƒ API é–‹ç™¼ (æ•™ç·´è¨˜éŒ„ã€è©•é‡ã€èªé ˜)
- [ ] Beta æ¸¬è©¦ (5 ä½æ•™ç·´ã€20 ä½å­¸ç”Ÿ)

### Phase 2 (å¢å¼·)
- [ ] æ‰¹æ¬¡æ“ä½œèˆ‡æ¨¡æ¿
- [ ] å­¸ç”Ÿé€²åº¦è¶¨å‹¢åœ–
- [ ] å­—å…¸ç¶­è­·å¾Œå°
- [ ] å ±è¡¨èˆ‡åŒ¯å‡º

### Phase 3 (å„ªåŒ–)
- [ ] é€²éšå ±è¡¨èˆ‡åˆ†æ
- [ ] I18N å¤šèªç³»
- [ ] Mobile App

---

## âœ… 11. Linus åŸå‰‡æª¢æŸ¥æ¸…å–®

### Good Taste âœ…
- [x] èƒ½åŠ›è©•é‡èˆ‡æ•™å­¸éç¨‹åˆ†é›¢ (`coach_ability_ratings` vs `lesson_detail_*`)
- [x] æ’åºç”±å¾Œç«¯çµ±ä¸€è™•ç† (æ¶ˆé™¤å‰ç«¯ `1..n` ç‰¹æ®Šæƒ…æ³)
- [x] å–®ä¸€è·è²¬ï¼šæ¯å€‹è¡¨åªåšä¸€ä»¶äº‹

### Never Break Userspace âœ…
- [x] v4 èˆŠè³‡æ–™å®Œæ•´é·ç§»
- [x] ä¸‰æ˜Ÿè©•ç­‰é«”ç³»ä¸è®Š
- [x] API å‘å¾Œç›¸å®¹ (æ–°å¢ä¸ç ´å£)

### Pragmatism âœ…
- [x] è§£æ±ºçœŸå¯¦å•é¡Œ (æ•™ç·´è¨˜æ†¶è² æ“”ã€å­¸ç”Ÿé€²åº¦è¿½è¹¤)
- [x] ç¹¼æ‰¿æ·±åº¦æ”¹ç‚ºæ¥­å‹™è¦å‰‡ (ä¸æ˜¯ DB ç´„æŸ)
- [x] ç›£è­·äººç”¨ UUID (ä¸é ä¸‰æ¬„ä½åŒ¹é…)

### Simplicity âœ…
- [x] æœ€å°å¯è¡Œæ¶æ§‹
- [x] é¿å…å¤šå±¤ç¸®æ’ (æ’åºé‚è¼¯çµ±ä¸€)
- [x] æ¶ˆé™¤éåº¦è¨­è¨ˆ (ç¹¼æ‰¿æ·±åº¦ã€position é€£çºŒæ€§)

---

## ğŸ“š é™„éŒ„

### A. åè©è¡¨
- **Outcome**: èƒ½åŠ›è©•é‡çš„çµæœè³‡æ–™ (æ˜Ÿç­‰ã€è©•èª)
- **Process**: æ•™å­¸éç¨‹è³‡æ–™ (åˆ†æã€ç·´ç¿’ã€å½±ç‰‡ã€æ‘˜è¦)
- **Mapping**: å…¨åŸŸå­¸ç”Ÿæ˜ å°„åˆ°é›ªå ´æˆ–èª²ç¨‹åŸŸçš„é—œä¿‚
- **ç¹¼æ‰¿**: æ²¿ç”¨æœ€è¿‘ä¸€æ¬¡è©•é‡ç‚ºåŸºç¤
- **P95**: 95 ç™¾åˆ†ä½å›æ‡‰æ™‚é–“æŒ‡æ¨™
- **RLS**: Row Level Security (PostgreSQL è¡Œç´šå®‰å…¨)

### B. è®Šæ›´æ—¥èªŒ

**v2.0 (2025-09-30)**:
- ğŸ”§ ç°¡åŒ– position é‚è¼¯ (å¾Œç«¯è‡ªå‹•ç·¨è™Ÿ)
- ğŸ”§ ç°¡åŒ–è©•é‡ç¹¼æ‰¿ (ç§»é™¤ DB æ·±åº¦ç´„æŸ)
- ğŸ”§ ç°¡åŒ–ç›£è­·äººæµç¨‹ (UUID ç‚ºä¸»)
- ğŸ“ åˆä½µ sdd-T.md èˆ‡ sdd-T-spec.md
- ğŸ“ ç§»é™¤é‡è¤‡å…§å®¹

**v1.0 (2025-09-29)**:
- åˆç‰ˆè¦æ ¼ (sdd-T.md + sdd-T-spec.md)

---

**æ–‡æª”ç¶­è­·**: æœ¬æ–‡æª”ç‚ºå”¯ä¸€æ­£å¼è¦æ ¼ï¼Œå…¶ä»–æ–‡æª”ä½œç‚ºæ­·å²åƒè€ƒã€‚
**ä¸‹æ¬¡æ›´æ–°**: åŠ å…¥æ—¥æœŸæ™‚é–“åˆ°æª”å `sdd-T-spec_YYYYMMDD_HHMMSS.md`
