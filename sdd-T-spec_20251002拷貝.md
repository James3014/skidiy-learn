# 滑雪教學評量系統 SDD-T 規格書

## 📋 文檔資訊
- **版本**: T-SPEC-2.4-ABILITY ⭐️ **最新版本**
- **建立日期**: 2025-10-01 09:46:33
- **最近更新**: 2025-10-24 18:30:00
- **修正原因**: 納入能力矩陣 CSV、教練評量語系對齊、補上 legacy 對照流程
- **基於**: sdd-T-spec_20251001_094633.md (修正版)
- **狀態**: 正式規格 (Latest)
- **變更摘要**:
  - 🔧 修正 `display_order SERIAL` → `INTEGER` (Service 層賦值)
  - 📝 補充完整表結構定義 (含所有約束與索引)
  - 📝 明確 Service 層排序邏輯實作
  - 🆕 教學紀錄共享欄位與 API、RLS、審計監控要求
  - 🆕 管理員可控 `can_view_shared_records` 權限與共享查詢流程
  - 🆕 座位身份表單 (`seat_identity_forms`) 與認領前驗證流程
  - ♻️ 收斂 `GET /lesson-records` 為單一端點，使用 `scope`/`visibility` 區分私有與共享查詢
  - 📦 `lesson_record_details` 冗餘 `resort_id` 與新索引，以支撐共享查詢效能
  - 🔒 共享授權預設保守：`can_view_shared_records=FALSE`、變更需 MFA + 審計 + Rate Limit
  - 🔗 共享媒體回應補充簽名 URL TTL（`expires_in`）
  - ⭐️ 教練評量頁同步顯示學生自評：外框 2.5px 加粗、雙星等 Tooltip、API `include=self_eval`
  - 🎯 教練評量頁新增學生類型標記（Doer/Thinker/Watcher）與後端儲存欄位
  - 🧭 ability_catalog 換成雙運動 179 項能力矩陣：支援 snowboard/ski、6 個等級與 CSV 種子匯入

---

## 🎯 1. 系統概述

### 1.1 系統宗旨
建立統一滑雪教學評量平台，同時服務「學生能力進度追蹤」與「教練教學過程記錄」。

### 1.2 Linus 核心原則

**Good Taste (好品味)**：
- 數據結構清晰分離：能力評量 (Outcome) ≠ 教學過程 (Process)
- 消除特殊情況：不讓前端管 position 連續性
- 單一職責：每個表只做一件事

**Never Break Userspace (向後相容)**：
- 完整保留 v4 評量資料和 API
- 舊評量記錄完整遷移
- 三星評等體系不變

**Pragmatism (實用主義)**：
- 解決真實問題：教練多課程記憶負擔、學生跨雪場進度追蹤
- 避免臆想威脅：不追蹤「繼承深度」到 DB 層
- 繼承層數限制改為業務規則，可動態調整

**Simplicity (簡潔)**：
- 最小可行架構
- 排序由後端統一處理
- 監護人用 UUID + 邀請連結，不用姓名+生日匹配

### 1.3 問題定義
- **教練痛點**: 統一平台記錄教學過程和評量結果
- **學生痛點**: 查看完整學習歷程（教練建議+能力進步）
- **管理痛點**: 整合報表和統一數據管理

---

## 👥 2. 角色與核心旅程

### 2.1 教練 (Instructor)
```
課程準備 → 教學執行 → 過程記錄 → 能力評量 → 課程總結
```

**關鍵功能**:
- 查看當日課程與席位狀態
- 記錄教學分析與練習 (後端自動排序)
- 能力評量 (1-3星 + 評語)
- 繼承學生最近評量 (任何教練)
- 批次操作提高效率

### 2.2 學生 (Student)
```
收到邀請 → 席位認領 → 課前自評 → 上課 → 查看評量 → 追蹤進度
```

**關鍵功能**:
- 邀請碼認領席位 (8字元)
- 課前自評 (可選)
- 查看教練評量與建議
- 能力進度趨勢圖
- 跨雪場評量歷史

### 2.3 管理員 (Admin)
```
系統設定 → 課程管理 → 字典維護 → 報表查詢 → 用戶管理
```

**關鍵功能**:
- 課程與席位管理
- 雙運動 179 項能力清單維護
- 教練帳號審核
- 系統報表與匯出
- 控管教練是否可檢視共享教學紀錄 (`can_view_shared_records`)

### 2.4 監護人 (Guardian)
```
收到學生邀請連結 → 用監護人 Email 登入 → 代表學生認領 → 課前自評 → 查看評量
```

**簡化設計**:
- 首次建立學生時給 `student_uuid`
- 後續用 UUID + 邀請連結，不靠姓名比對
- 監護人登入後可切換孩子身份

---

## 📊 3. User Stories (優先級分組)

### Phase 1 (P0) - MVP 必須

#### Epic 1: 教練教學管理
**US-T01: 課程準備**
- 查看當日課程與席位狀態
- 顯示學生上次評量摘要與自評狀態
- **AC**: 席位狀態 (pending/claimed)、自評狀態、歷史評量
- **Story Points**: 5

**US-T02: 教學過程記錄**
- 記錄教學分析與練習設計
- 上傳教學影片
- **改進**: 後端自動維護 `display_order`，前端只傳 ID 陣列
- **Story Points**: 8

**US-T03: 能力評量**
- 雙運動 179 項能力清單評量 (1-3星 + 評語)
- 查看學生自評對比
  - UI：自評外框 2.5px 實線加粗，未自評顯示 1.5px 虛線 + Badge「未自評」
  - Tooltip 同步顯示「自評：★☆☆」「教練評分：★★★」等雙星等資訊
- 標記學生類型（多選 Chips）：實踐型 Doer、思考型 Thinker、觀察型 Watcher，預設沿用最近一筆紀錄
- 星等語系：1★=「了解 (knew)」、2★=「熟悉 (familiar)」、3★=「精熟 (excellent)」，與歷史評量 CSV (`knew/familiar/excellent`) 對齊以利資料遷移
- 一鍵繼承最近評量 (跨教練)
- **AC**: `GET /coach/lessons/{id}?include=self_eval` 或 `GET /lessons/{id}/seats?include=self_eval` 時，學生清單與評量頁需帶回 `self_eval`、`student_types` 欄位；教師可在評量送出時更新 `student_types`
- **改進**: 移除 `inheritance_depth` DB 約束，改為 Service 層檢查
- **Story Points**: 8

**US-T05: 教學總結**
- 自動生成摘要、填寫優點與建議
- 設定評量狀態為已完成
- **Story Points**: 3

**US-T06: 教學紀錄共享**
- 教練可針對單筆/多筆紀錄設定 `private/resort/all`
- 僅在共享狀態與教練權限允許下才開放查詢
- 共享查閱需支援依問題、練習、雪場、教練篩選
- **Story Points**: 8

#### Epic 2: 學生學習體驗
**US-S01: 席位認領**
- 輸入 8 位邀請碼認領席位
- 成年/未成年分流處理
- **改進**: 監護人用 UUID 邀請連結，不用三欄位匹配
- **Story Points**: 5

**US-S03: 評量結果查看**
- 顯示教練星等與評語
- 對比自評與教練評量差異
- 查看教學影片
- **Story Points**: 5

**US-S06: 認領前身份填寫**
- 訂課後每個座位產生身份表單（姓名、生日、Email 等）
- 監護人可透過邀請連結補填/修改
- 認領前顯示核對資訊，表單未完成不可認領
- **Story Points**: 5

#### Epic 4: 系統遷移
**US-M01: v4 資料遷移**
- 遷移用戶、課程、評量資料
- 建立學生映射關係
- 驗證資料完整性
- **Story Points**: 13

**US-M02: 向後相容**
- 保持操作習慣與資料格式
- 支援舊邀請流程
- **Story Points**: 8

### Phase 2 (P1) - 增強功能

#### Epic 1: 批次操作
**US-T04: 批次處理**
- 複製上堂課教學設計
- 批次設定多位學生評量
- 快速套用評語模板
- **Story Points**: 5

#### Epic 2: 學生自評與進度
**US-S02: 課前自評**
- 1-3星自評 + 可選註解
- 支援草稿儲存
- **Story Points**: 5

**US-S04: 學習進度追蹤**
- 能力歷史變化與趨勢圖
- 按雪場/教練篩選
- 匯出 PDF 報告
- **Story Points**: 8

#### Epic 3: 管理維護
**US-A01: 課程管理**
- 建立課程、管理席位
- 邀請碼生成與延長
- **Story Points**: 8

**US-A02: 字典維護**
- 管理能力、分析、練習項目
- 雪場與雪道資訊
- 審計日誌
- **Story Points**: 8

**US-A03: 用戶管理**
- 審核教練帳號
- 角色與權限設定
- MFA 管理
- **Story Points**: 5

**US-A04: 共享權限管理**
- 可為個別教練開啟/關閉「查閱共享紀錄」能力 (`can_view_shared_records`)
- 查看共享權限調整歷史
- 一鍵回收某教練所有共享開關
- **Story Points**: 5

### Phase 3 (P2) - 分析報表

**US-A05: 報表與分析**
- 教練完成率統計
- 學生參與率分析
- 雪場使用統計
- 能力掌握度切片：依 sport_type × skill_level × proficiency_band 匯總，對應 `abilitylist.csv`
- CSV/PDF 匯出
- **Story Points**: 8

**US-S05: 課程歷史**
- 按時間列出所有課程
- 快速預覽評量與建議
- **Story Points**: 3

---

## 🗄️ 4. 資料模型 (簡化版)

### 4.1 核心表一覽

| 表名 | 用途 | 關鍵欄位 |
|------|------|----------|
| `accounts` | 登入帳號、角色、MFA | role, status, mfa_enabled（由訂課平台同步） |
| `instructors` | 教練資料 | account_id, resorts（由訂課平台提供） |
| `global_students` | 全域學生身份 | id (UUID), email, phone |
| `student_mappings` | 學生與雪場映射 | global_student_id, resort_id |
| `guardian_relationships` | 監護人關係 | guardian_email, student_id |
| `resorts` | 雪場資訊 | name, location |
| `lessons` | 課程 | resort_id, date, instructor_id（由訂課平台載入） |
| `order_seats` | 席位 | lesson_id, seat_number, status, version（由訂課平台載入） |
| `seat_invitations` | 邀請碼 | code (8 chars), seat_id, expires_at |
| `seat_identity_forms` | 認領前身份資料 | seat_id, status, student_name, contact_email |
| `lesson_records` | 教學記錄主檔 | lesson_id, summary, videos |
| `lesson_record_details` | 學生教學詳情 | record_id, student_mapping_id, share_visibility, student_types |
| `lesson_detail_analyses` | 分析明細 | detail_id, analysis_id, display_order |
| `lesson_detail_practices` | 練習明細 | detail_id, drill_id, display_order |
| `ability_catalog` | 雙運動 179 項能力矩陣 | name, category, sport_type, skill_level, sequence_in_level, description |
| `coach_ability_ratings` | 教練評量 | rating (1-3), proficiency_band, comment, source_rating_id |
| `student_self_evaluations` | 學生自評 | self_rating (1-3), self_comment |
| `legacy_id_mappings` | 舊系統索引對照 | legacy_type, legacy_id, new_entity_id |

`student_types` 使用 `student_persona_enum[]` 儲存學生的學習型態標記，枚舉值含 `doer`（實踐型）、`thinker`（思考型）、`watcher`（觀察型），以利教練跨課程追蹤學生傾向。

> 訂課平台為單一來源：`accounts`、`instructors`、`lessons`、`order_seats` 均由訂課系統同步或匯入，本系統不重新建立課程與帳號，而是增補教學紀錄、評量與共享資料。

### 4.2 重要欄位設計 (改進版)

#### 4.2.1 排序欄位簡化 (🔧 已改進)

```sql
-- ❌ 舊設計：前端管 position 連續性
lesson_detail_analyses (
    position SMALLINT NOT NULL,
    UNIQUE(lesson_record_detail_id, position)
);

-- ✅ 新設計：Service 層賦值排序
lesson_detail_analyses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_record_detail_id UUID NOT NULL REFERENCES lesson_record_details(id) ON DELETE CASCADE,
    analysis_group_id INTEGER REFERENCES analysis_groups(id),
    analysis_id INTEGER REFERENCES analysis_items(id),
    custom_analysis TEXT,
    display_order INTEGER NOT NULL,  -- Service 層填入 1, 2, 3...
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (analysis_id IS NOT NULL OR custom_analysis IS NOT NULL),
    UNIQUE(lesson_record_detail_id, display_order)
);

-- API 端點
POST /api/v1/lesson-records/{id}/analyses/reorder
Body: { "analysis_ids": ["uuid1", "uuid2", "uuid3"] }

-- Service 層實作 (Python 範例)
def reorder_analyses(lesson_record_detail_id, analysis_ids):
    """重新排序分析項目，賦值 1, 2, 3..."""
    with db.transaction():
        rows = db.fetch_all(
            "SELECT id FROM lesson_detail_analyses WHERE lesson_record_detail_id = %s",
            (lesson_record_detail_id,)
        )
        existing_ids = {row.id for row in rows}
        incoming_ids = set(analysis_ids)
        if incoming_ids != existing_ids:
            raise BusinessError(
                code="ANALYSIS_SET_MISMATCH",
                message="重新排序需提交完整且不重複的分析項目 ID"
            )
        for idx, analysis_id in enumerate(analysis_ids, start=1):
            db.execute(
                """UPDATE lesson_detail_analyses
                       SET display_order = %s, updated_at = NOW()
                       WHERE id = %s AND lesson_record_detail_id = %s""",
                (idx, analysis_id, lesson_record_detail_id)
            )

-- 練習明細表結構 (同理)
lesson_detail_practices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_record_detail_id UUID NOT NULL REFERENCES lesson_record_details(id) ON DELETE CASCADE,
    skill_id INTEGER REFERENCES skills(id),
    drill_id INTEGER REFERENCES practice_drills(id),
    custom_drill TEXT,
    practice_notes TEXT,
    display_order INTEGER NOT NULL,  -- Service 層填入 1, 2, 3...
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CHECK (drill_id IS NOT NULL OR custom_drill IS NOT NULL),
    UNIQUE(lesson_record_detail_id, display_order)
);
```

#### 4.2.2 ability_catalog 雙運動矩陣（🧭 新增）

- **資料來源**：`abilitylist.csv` 共 179 筆，含 120 筆 Snowboard (`type=sb`) 與 59 筆 Ski (`type=ski`)，皆依 6 個 `level`（1~6）分組。
- **欄位映射**：
  - `sport_type` 改用 `sport_type_enum ('snowboard','ski')`，由 CSV `type` 對應。
  - `skill_level` 採用 CSV `level`（1=入門～6=高階），`sequence_in_level` 取自 `number` 欄位以維持層內排序。
  - `description` 對應 `explanation`，允許空字串，但保留欄位以便後續補完。
- **統計摘要**：（用於 UI grouping 與 QA 指標）
  - Snowboard：每一層 (1~6) 皆 20 項。
  - Ski：依序為 10 / 11 / 7 / 9 / 9 / 13 項。
- **匯入機制**：提供 `catalog.seed_abilities_from_csv(path)` 管理工具僅限管理員執行；同一 `sport_type + skill_level + sequence_in_level` 出現時執行 UPSERT，維護 `updated_at`。
- **API / UI 影響**：
  - `GET /api/v1/catalog/abilities?sport_type=snowboard&level=3` 回傳特定運動與層級能力，預設依 `sequence_in_level` 排序。
  - 教練評量頁能力樹需以「運動別 → 層級 → 能力項目」展開，左側提供關鍵字搜尋。

```sql
CREATE TYPE sport_type_enum AS ENUM ('snowboard', 'ski');

ability_catalog (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT,
    sport_type sport_type_enum NOT NULL,
    skill_level SMALLINT NOT NULL CHECK (skill_level BETWEEN 1 AND 6),
    sequence_in_level SMALLINT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (sport_type, skill_level, sequence_in_level)
);
```

#### 4.2.3 評量繼承簡化 (🔧 已改進)

- `rating` 仍維持 1~3 星，但與 `evaluationrecords_2425.csv` 的 `knew/familiar/excellent` 對應，並同步寫入新欄位 `proficiency_band`（值域：knew/familiar/excellent）。
- 導入 `coach_proficiency_band_enum` 以保留語意，Service 層將 `rating=1` 映射 `knew`、`rating=2` 映射 `familiar`、`rating=3` 映射 `excellent`，缺值時拒絕寫入。

```sql
CREATE TYPE coach_proficiency_band_enum AS ENUM ('knew', 'familiar', 'excellent');

-- ❌ 舊設計：DB 層約束繼承深度
coach_ability_ratings (
    inheritance_depth SMALLINT DEFAULT 0 CHECK (inheritance_depth <= 2),
    inherited_from_rating_id UUID,
    inheritance_note TEXT
);

-- ✅ 新設計：移除 depth 約束，改為 Service 層檢查
coach_ability_ratings (
    id UUID PRIMARY KEY,
    lesson_record_detail_id UUID REFERENCES lesson_record_details(id),
    ability_id INTEGER REFERENCES ability_catalog(id),
    rating SMALLINT NOT NULL CHECK (rating BETWEEN 1 AND 3),
    proficiency_band coach_proficiency_band_enum NOT NULL,
    comment TEXT NOT NULL,
    source_rating_id UUID REFERENCES coach_ability_ratings(id), -- 單層引用
    rated_by INTEGER NOT NULL REFERENCES accounts(id),
    rated_at TIMESTAMPTZ DEFAULT NOW(),
    version INTEGER DEFAULT 1,
    UNIQUE(lesson_record_detail_id, ability_id)
);

-- Service 層檢查 (可配置)
MAX_INHERITANCE_DEPTH = 2  # 業務規則，非 DB 約束

def validate_inheritance(source_rating_id):
    depth = 0
    current = source_rating_id
    seen = set()
    while current and depth < MAX_INHERITANCE_DEPTH:
        if current in seen:
            raise BusinessError(
                code="INHERITANCE_INVALID_CHAIN",
                message="來源評量鏈出現循環，請改用手動評量"
            )
        seen.add(current)
        current = get_source_rating_id(current)
        depth += 1
    if depth >= MAX_INHERITANCE_DEPTH:
        raise BusinessError(
            code="INHERITANCE_DEPTH_EXCEEDED",
            message=f"來源評量僅允許 {MAX_INHERITANCE_DEPTH} 層繼承"
        )
```

#### 4.2.4 監護人流程簡化 (🔧 已改進)

```sql
-- ❌ 舊設計：三欄位匹配 (監護人Email, 學生姓名, 出生年)
-- 問題：大小寫、trim、拼音差異

-- ✅ 新設計：UUID 為主
global_students (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255),
    phone VARCHAR(20),
    birth_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

guardian_relationships (
    id UUID PRIMARY KEY,
    guardian_email VARCHAR(255) NOT NULL,
    student_id UUID REFERENCES global_students(id),
    relationship_type guardian_type_enum, -- parent/guardian/relative
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(guardian_email, student_id)
);

-- 邀請流程
-- 1. 首次建立學生時產生 UUID
-- 2. 產生短連結: /claim/{student_uuid}?token={short_code}
-- 3. 監護人點擊連結，用自己 Email 登入
-- 4. 系統自動建立 guardian_relationships
-- 5. 後續都用 UUID，不再比對姓名
-- 6. token 只儲存雜湊值，有效期預設 7 天；認領成功或撤銷立即失效
-- 7. 同一監護人可認領多名學生，但 UNIQUE 約束避免重複認領同一學生
```

#### 4.2.5 認領前身份資料（新增）

```sql
CREATE TYPE seat_identity_status_enum AS ENUM ('draft', 'submitted', 'confirmed');

CREATE TABLE seat_identity_forms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    seat_id UUID NOT NULL REFERENCES order_seats(id) ON DELETE CASCADE,
    status seat_identity_status_enum DEFAULT 'draft',
    student_display_name VARCHAR(100),
    student_english_name VARCHAR(100),
    birth_date DATE,
    contact_email VARCHAR(255),
    guardian_email VARCHAR(255),
    contact_phone VARCHAR(30),
    has_external_insurance BOOLEAN DEFAULT FALSE,
    insurance_provider VARCHAR(100),
    note TEXT,
    submitted_at TIMESTAMPTZ,
    confirmed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(seat_id)
);

CREATE INDEX idx_seat_identity_forms_status ON seat_identity_forms(status);
```

流程：

1. **訂課後**：每個 `order_seat` 自動建立一筆 `seat_identity_forms`（`status=draft`）。
2. **填寫身份表單**：訂課人或監護人透過後台／邀請連結補齊學生姓名、生日、Email（未成年需監護人 Email）。表單儲存為 `submitted`。
3. **確認認領**：當監護人使用邀請連結認領時，系統顯示表單內容供核對；若確認無誤即將 `status` 改為 `confirmed`，並建立/綁定 `global_students` → `student_mappings`。
4. **修改/撤銷**：若發現填錯，可在後台重設表單（重設為 `draft`，重新寄送連結），並記錄 audit。
5. **保險欄位選擇性**：`has_external_insurance` / `insurance_provider` 用於標記是否由外部保險，避免勉強要求保險資料。

API 影響：
- `GET /api/v1/seats/{id}/identity-form`：後台查詢表單內容。
- `PUT /api/v1/seats/{id}/identity-form`：管理員/訂課人更新表單。
- `POST /api/v1/invitations/{code}/identity`：公開端點，監護人填寫或更新表單。
- `POST /api/v1/invitations/{code}/confirm`：最終認領，需檢查表單為 `submitted/confirmed` 並顯示確認資訊。

審計：每次更新 `seat_identity_forms` 或改變認領狀態都需寫入 `audit_logs`（`action`: `seat_identity_update`/`seat_claim_confirm`）。

錯誤碼：若 `status != submitted` 卻嘗試確認，回傳 `IDENTITY_FORM_INCOMPLETE (422)`；若 `confirmed` 後再次填寫則須先復原。

#### 4.2.6 教學紀錄共享控制（新增）

```sql
CREATE TYPE record_share_visibility_enum AS ENUM ('private', 'resort', 'all');
CREATE TYPE student_persona_enum AS ENUM ('doer', 'thinker', 'watcher');

lesson_record_details (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_record_id UUID NOT NULL REFERENCES lesson_records(id) ON DELETE CASCADE,
    student_mapping_id UUID NOT NULL REFERENCES student_mappings(id),
    resort_id INTEGER NOT NULL REFERENCES resorts(id),
    share_visibility record_share_visibility_enum DEFAULT 'private',
    student_types student_persona_enum[] NOT NULL DEFAULT ARRAY[]::student_persona_enum[],
    shared_at TIMESTAMPTZ,
    shared_by INTEGER REFERENCES accounts(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE instructors ADD COLUMN can_view_shared_records BOOLEAN DEFAULT FALSE;

-- 透過 Trigger 維護冗餘 resort_id，避免共享查詢過度 JOIN
CREATE OR REPLACE FUNCTION trg_lrd_sync_resort() RETURNS trigger AS $$
BEGIN
    NEW.resort_id := (
        SELECT lr.resort_id FROM lesson_records lr WHERE lr.id = NEW.lesson_record_id
    );
    RETURN NEW;
END;$$ LANGUAGE plpgsql;

CREATE TRIGGER sync_lrd_resort
BEFORE INSERT OR UPDATE ON lesson_record_details
FOR EACH ROW EXECUTE FUNCTION trg_lrd_sync_resort();
```

共享規則：

- `private`: 只有授課教練、管理員可見。
- `resort`: 同一 `resort_id` 的教練可見，前提是 `can_view_shared_records = TRUE`。
- `all`: 任何教練（含外部）可見，仍需 `can_view_shared_records = TRUE`。
- `student_types`: 儲存學生類型標記（`doer`/`thinker`/`watcher`），Service 層若未帶入則沿用上一筆評量紀錄，便於觀察學習型態變化。
- `can_view_shared_records` 預設 `FALSE`，僅系統管理員可調整；每次變更需通過 MFA、提供理由並寫入 `audit_logs` (`action=capability_toggle`)。
- 分享或回收時必須透過 `PATCH /share-visibility`，強制帶入原因並寫入 `audit_logs`（`shared_by`、`shared_at`、`reason`）。
- 共享查詢 (`scope=shared`) 受 30 次/分鐘/使用者 Rate Limit，逾限回 429 並記錄失敗審計。

RLS 建議：

```sql
CREATE POLICY lesson_record_details_owner_policy ON lesson_record_details
USING (
    lesson_record_id IN (
        SELECT id FROM lesson_records
        WHERE instructor_id = current_setting('app.current_instructor_id')::INTEGER
    )
);

CREATE POLICY lesson_record_details_share_policy ON lesson_record_details
FOR SELECT USING (
    current_setting('app.can_view_shared_records')::BOOLEAN = TRUE
    AND (
        share_visibility = 'all'
        OR (
            share_visibility = 'resort'
            AND resort_id = current_setting('app.current_resort_id')::INTEGER
        )
    )
);
```

API 變更：
- `PATCH /api/v1/lesson-records/{id}/share-visibility` 更新 `share_visibility`（僅授課教練或管理員，必須記錄 audit）。
- `GET /api/v1/lesson-records/private`：回傳操作者自己課程的紀錄，可選 `include_shared=false` 以排除共享。
- `GET /api/v1/lesson-records/shared`：回傳符合可見條件的共享紀錄，可搭配 `visibility`、`analysis`、`tactic`、`resort`、`instructor`、時間範圍等查詢參數。

查詢優化：
- 針對共享查詢新增索引 `idx_lesson_record_details_visibility_resort`：
  ```sql
  CREATE INDEX idx_lesson_record_details_visibility_resort
  ON lesson_record_details(share_visibility, resort_id);
  ```
- 前端在共享列表提供 `analysis`、`tactic`、`resort`、`instructor` 篩選，與舊系統一致。

#### 4.2.7 席位認領併發控制

```sql
order_seats (
    id UUID PRIMARY KEY,
    lesson_id INTEGER REFERENCES lessons(id),
    seat_number SMALLINT CHECK (seat_number BETWEEN 1 AND 6),
    claimed_mapping_id UUID REFERENCES student_mappings(id),
    status seat_status_enum DEFAULT 'pending',
    claimed_at TIMESTAMPTZ,
    version INTEGER DEFAULT 1, -- 樂觀鎖
    created_at TIMESTAMPTZ DEFAULT NOW()
);

seat_invitations (
    code VARCHAR(8) PRIMARY KEY DEFAULT SUBSTRING(gen_random_uuid()::text, 1, 8),
    seat_id UUID NOT NULL REFERENCES order_seats(id),
    expires_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '7 days',
    claimed_at TIMESTAMPTZ,
    claimed_by UUID REFERENCES student_mappings(id)
);

-- Enum 定義 (避免實作者猜測)
CREATE TYPE guardian_type_enum AS ENUM ('parent', 'guardian', 'relative');
CREATE TYPE seat_status_enum AS ENUM ('pending', 'invited', 'claimed', 'completed', 'expired');
```

邀請碼產生需具備重試：若 `SUBSTRING(gen_random_uuid(), 1, 8)` 撞到現有主鍵，Service 層必須在交易內最多重試 5 次，仍失敗則回傳 `INVITE_CODE_COLLISION` 業務錯誤並改採後備策略（例如切換為 12 碼 base32 亂數或呼叫 batch 預生池），避免靜默失敗。

共享查詢需同時檢查 `lesson_record_details.share_visibility` 與教練權限 `instructors.can_view_shared_records`，一旦權限被撤銷即刻禁止閱讀共享紀錄。所有共享查詢執行後需寫入 `audit_logs`（教練帳號、查詢條件、筆數），以及監控 `shared_query_count` 指標。

**席位狀態流轉**
```
pending ─(產生邀請碼)→ invited ─(邀請逾期)→ expired
    │                            └─(排程清理)┘
    └─(學生/監護人認領成功)→ claimed ─(教練完成評量)→ completed

- invited: 呼叫產生邀請碼 API 後設定，重寄時更新 `expires_at`
- expired: 排程依 `expires_at < now()` 更新座位狀態與回收邀請碼
- claimed: `order_seats` 樂觀鎖更新成功即進入此狀態
- completed: 教練提交課程總結/評量完成後由後端統一更新
```

排程需記錄 `job_runs`（開始/結束時間、處理筆數、錯誤訊息），並輸出至少兩個監控指標：`expired_invites_processed` 與 `job_failure`。任一輪失敗需觸發告警（Slack/Webhook），以免邀請長期停留在 `invited` 狀態。

#### 4.2.8 Service 層實作原則（語言無關）

- **交易原則**：任何會變動順序、狀態或繼承鏈的操作必須包在單一交易內，失敗即整體 rollback。
- **錯誤對映**：內部錯誤統一映射為帶 code 的 BusinessError（例如 `ANALYSIS_SET_MISMATCH`, `INHERITANCE_INVALID_CHAIN`, `INVITE_CODE_COLLISION`），API 返回 422/409 並提供中文訊息。
- **審計紀錄**：排序、繼承、席位認領與排程作業都需寫入 `audit_logs` 或 `job_runs`，便於回溯。
- **防呆檢查**：所有 ID 輸入先驗證 ownership（教練只能動自己課程，學生只能看自己紀錄），杜絕橫向越權。
- **擴充接口**：排程與外部通知採用 Message Queue / 任務框架抽象，避免綁定特定語言實作細節。
- **共享查詢**：統一封裝 `build_shared_query(ctx)`，內部檢查 `share_visibility`、`can_view_shared_records`，並將查詢參數與結果筆數記錄到審計與監控。
- **學生類型標記**：更新 `lesson_record_details.student_types` 時需校驗 enum，未提供時沿用該學生最近一筆課程紀錄；共享查詢預設返回完整標記供跨教練參考。
- **身份表單**：提供 `submit_identity_form`/`confirm_seat_claim` 方法，須驗證必填欄位，status 不符時回傳 `IDENTITY_FORM_INCOMPLETE`，並寫入 audit/metrics。
- **Legacy 對照**：維護 `legacy_id_mappings`（`legacy_type` = student_idx / lesson_idx / ability_idx），供 `evaluationrecords_2425.csv` 遷移與後續追蹤；Service 層取得或建立對照後方可寫入正式表格。

### 4.3 索引策略

```sql
-- 評量查詢優化
CREATE INDEX idx_coach_ratings_student_lesson
ON coach_ability_ratings(lesson_record_detail_id, ability_id);

CREATE INDEX idx_coach_ratings_source
ON coach_ability_ratings(source_rating_id)
WHERE source_rating_id IS NOT NULL;

-- 能力目錄查詢
CREATE INDEX idx_ability_catalog_sport_level
ON ability_catalog(sport_type, skill_level, sequence_in_level);

-- 自評查詢
CREATE INDEX idx_self_eval_student_lesson
ON student_self_evaluations(student_mapping_id, lesson_id);

-- 學生類型查詢
CREATE INDEX idx_lesson_record_details_student_types
ON lesson_record_details USING GIN (student_types);

-- 學生映射
CREATE INDEX idx_student_mappings_global
ON student_mappings(global_student_id);

-- 邀請碼快速驗證
CREATE INDEX idx_seat_invitations_code
ON seat_invitations(code, expires_at)
WHERE claimed_at IS NULL;

-- 排序查詢
CREATE INDEX idx_analyses_display_order
ON lesson_detail_analyses(lesson_record_detail_id, display_order);
```

---

## 🔌 5. API 設計 (簡化版)

### 5.1 認證與帳號
```
POST   /api/v1/auth/login           # Email+密碼，返回 JWT
POST   /api/v1/auth/refresh         # 刷新 Token
GET    /api/v1/me                   # 當前用戶資訊
POST   /api/v1/accounts             # Admin: 建立帳號
```

### 5.2 課程與席位 (🔧 已改進)
```
GET    /api/v1/lessons?role=coach&date=    # 課程清單
POST   /api/v1/lessons                     # 建立課程
GET    /api/v1/lessons/{id}/seats?include=self_eval
                                                 # 席位狀態 + (選用) 學生自評星等與評論摘要
POST   /api/v1/seats/{id}/invitations      # 產生邀請碼
POST   /api/v1/invitations/claim           # 認領席位 (樂觀鎖)

# 🆕 監護人邀請 (簡化)
GET    /api/v1/invite/student/{student_uuid}?token={code}
       # 監護人點擊連結，自動建立關係
GET    /api/v1/seats/{id}/identity-form         # 後台：查看身份表單
PUT    /api/v1/seats/{id}/identity-form         # 後台：更新身份表單
POST   /api/v1/invitations/{code}/identity      # 公開：填寫/更新身份表單
POST   /api/v1/invitations/{code}/confirm       # 公開：確認認領並綁定學生
```

### 5.3 教練教學記錄 (🔧 已改進)
```
GET    /api/v1/coach/lessons/{id}?include=self_eval  # 課程概況 + 學生自評欄位
GET    /api/v1/students/{mapping_id}/latest-ratings  # 最近評量 (繼承用)
POST   /api/v1/lesson-records                        # 建立教學記錄
POST   /api/v1/lesson-records/{id}/ratings           # 批次評量
       # Request body 裡的每個 student_detail 支援 `student_types: ["doer","thinker"]`（多選，沿用上次紀錄為預設）

# 🆕 排序 API (簡化)
POST   /api/v1/lesson-records/{id}/analyses/reorder
Body:  { "analysis_ids": ["uuid1", "uuid2", "uuid3"] }
       # 後端自動設定 display_order = 1, 2, 3

POST   /api/v1/lesson-records/{id}/practices/reorder
Body:  { "practice_ids": ["uuid1", "uuid2", "uuid3"] }

PATCH  /api/v1/lesson-records/{id}/share-visibility
Body:  { "detail_id": "uuid", "share_visibility": "private|resort|all", "reason": "文字" }
       # 必須附上 `X-MFA-Token` + `X-Idempotency-Key`，寫入 audit_logs (shared_by/shared_at/reason)

GET    /api/v1/lesson-records
Params:
  scope=private|shared (default=private)
  visibility=private|resort|all （僅 scope=shared 生效，且 shared 時必填）
  include_shared=true|false （僅 scope=private；預設 true，false 時排除已分享紀錄）
  analysis=ID / tactic=ID / resort=ID / instructor=ID
  q=keyword, sort=created_at:desc
  page=1, page_size=20（最大 100）
Notes:
- scope=shared 需要 `can_view_shared_records=TRUE`，並受 30 次/分鐘/使用者節流。
- 回應依 scope 自動脫敏；共享結果回傳簽名 URL 與 `expires_in` (秒)。
- 每次查詢寫入 `audit_logs`，`scope=shared` 另記錄結果筆數、filters。
- `include=self_eval` 同時載入 `self_eval` 與 `student_types` 欄位，供教練比對自評差異與學生類型標記。

`scope=shared` Response:
```json
{
  "data": [
    {
      "detail_id": "uuid",
      "lesson_id": "uuid",
      "lesson_date": "2025-02-18",
      "instructor_name": "林教練",
      "resort": "苗場 (Naeba)",
      "share_visibility": "resort",
      "analysis": {
        "category": "站姿與平衡",
        "analysis": "重心在前腳",
        "analysis_desc": "重心太前腳導致板尾滑開"
      },
      "tactic": {
        "skill": "橫向運動-立刃",
        "tactic": "滑行重心轉移",
        "tactic_desc": "嘗試轉彎時前後重心切換"
      },
      "feedback": {
        "summary": "正面回饋與建議的脫敏摘要",
        "link_before": "https://signed/...",
        "link_after": "https://signed/..."
      },
      "media_ttl": 86400,
      "shared_at": "2025-02-18T05:30:00Z",
      "shared_by": "UUID"
    }
  ],
  "meta": {
    "scope": "shared",
    "visibility": "resort",
    "filters": {
      "analysis": "重心在前腳",
      "tactic": null
    },
    "page": 1,
    "page_size": 20,
    "count": 12,
    "expires_in": 86400
  }
}
```

`scope=private` Response:
```json
{
  "data": [
    {
      "detail_id": "uuid",
      "lesson_id": "uuid",
      "lesson_date": "2025-02-18",
      "resort": "苗場 (Naeba)",
      "course": "A1 大斜面",
      "analysis": {
        "category": "站姿與平衡",
        "analysis": "重心在前腳",
        "analysis_desc": "重心太前腳導致板尾滑開"
      },
      "tactic": {
        "skill": "橫向運動-立刃",
        "tactic": "滑行重心轉移",
        "tactic_desc": "嘗試轉彎時前後重心切換"
      },
      "feedback": {
        "positive": "基本站姿良好",
        "try": "練習海豚式轉彎",
        "comment": "完整評語與注意事項",
        "link_before": "https://signed/...",
        "link_after": "https://signed/..."
      },
      "share_visibility": "private"
    }
  ],
  "meta": {
    "scope": "private",
    "include_shared": true,
    "page": 1,
    "page_size": 20,
    "count": 5
  }
}
```

隱私要求：
- 共享回應不得包含學生姓名、Email、電話等個資。
- `link_before/link_after` 皆使用簽名 URL，預設 TTL=24h，可透過 Feature Flag 切換 12h/72h；到期強制回 403。
- `feedback.summary` 為脫敏後的建議摘要，完整文字僅限原教練或管理員在 scope=private 時存取。

安全：
- scope=private 回應可包含完整教練回饋與影片連結，但僅限原教練或管理員查看。
- API 必須使用 JWT 內的教練 ID 驗證呼叫者身分，禁止其它教練或外部使用者存取。
- 所有查詢需寫入審計（`action=lesson_lookup`，並標示 scope/filters）。
```

### 5.4 學生自評與進度
```
POST   /api/v1/students/me/self-evaluations       # 提交自評
GET    /api/v1/students/me/progress                # 歷史評量與趨勢
GET    /api/v1/students/me/lessons/{id}           # 課程詳情
POST   /api/v1/students/me/identity/merge         # 合併重複身份
```

### 5.5 字典維護
```
GET/POST/PATCH /api/v1/catalog/abilities           # 能力清單（GET 支援 query: sport_type, level, keyword）
GET/POST/PATCH /api/v1/catalog/analysis-groups     # 分析項目
GET/POST/PATCH /api/v1/catalog/practice-drills     # 練習項目
GET/POST       /api/v1/templates/summary           # 評語模板
```

### 5.5.1 測試與監控備註
- 共享/私有 API 需覆蓋以下測試案例：
  1. 無權限教練查詢共享 => 403
  2. `include_private` 對非擁有者 => 空結果
  3. 不同 `visibility` 組合 (resort/all)
  4. 審計與 metrics 寫入成功（mock 或檢查 log）
- 監控指標：`shared_query_count` (by coach_id, visibility)、`private_query_count`、`shared_query_failure`。
- Audit log 標準欄位：`actor_id`, `action`, `filters`, `count`, `performed_at`.

### 5.6 錯誤碼

```json
{
  "success": false,
  "error": {
    "code": "SEAT_CLAIMED",
    "message": "席位已被認領",
    "details": {
      "claimed_at": "2025-09-30T12:00:00Z",
      "claimed_by": "王小明"
    }
  }
}
```

**標準錯誤碼**:
- `VALIDATION_ERROR` (400)
- `UNAUTHORIZED` (401)
- `FORBIDDEN` (403)
- `NOT_FOUND` (404)
- `CONFLICT` (409) - version 不符
- `SEAT_CLAIMED` (423) - 席位已被認領
- `INVITE_EXPIRED` (410) - 邀請碼過期
- `ANALYSIS_SET_MISMATCH` (422) - 重新排序 ID 不完整或重複
- `INHERITANCE_INVALID_CHAIN` (422) - 來源評量鏈循環或不存在
- `INHERITANCE_DEPTH_EXCEEDED` (422) - 超過允許的繼承層數
- `INVITE_CODE_COLLISION` (409) - 短碼產生多次碰撞，需稍候再試
- `INVALID_VISIBILITY` (422) - 非法共享狀態
- `IDENTITY_FORM_INCOMPLETE` (422) - 認領前身份資料尚未完成
- `ONLY_OWNER_CAN_SHARE` (403) - 非授課教練試圖修改共享設定
- `RATE_LIMITED` (429)

---

## 🎨 6. 前端設計重點

### 6.1 教練工作區
- **儀表板**: 今日課程、席位狀態、未完成評量提醒
- **課程頁**:
  - 左側學生清單: 邀請狀態、自評、最近評量摘要
  - 右側表單: 分頁切換「教學過程」「能力評量」
  - 能力評量頁：自評星等以 2.5px 實線外框呈現（未自評改 1.5px 虛線 + Badge「未自評」），教練星等為可操作實心填滿；Hover/Focus Tooltip 顯示雙星等（例：自評：★☆☆｜教練：★★★）
  - 學生類型區塊：Doer/Thinker/Watcher 以膠囊 Chip 呈現，支援多選、鍵盤切換與預設帶入上一筆紀錄
  - 能力清單：依 sport_type（snowboard/ski）→ skill_level（1~6）→ 項目排序呈現，支援關鍵字快速搜尋與 CSV 種子同步狀態提示
  - **排序改進**: 拖拉排序後只傳 `analysis_ids` 陣列
- **歷史頁**: 依學生或課程查詢
- **共享中心**: 提供 `private/resort/all` 開關、問題/練習/雪場/教練/日期篩選、共享列表（顯示教練、雪場、共享時間、回饋摘要），支援批次分享與回收並顯示審計提示

### 6.2 學生專區
- **課程列表**: 最近課程、即將到來、自評入口
- **課程詳情**: 星等、自評差異、建議、影片
- **能力趨勢圖**: 折線圖顯示星等歷史

### 6.3 管理後台
- **字典維護**: 列表 + 右側編輯、批次匯入
- **席位監控**: 邀請狀態、逾期提醒、重寄邀請
- **報表**: 教練績效、雪場統計、匯出

---

## 🔒 7. 安全、隱私與效能

### 7.1 安全
- **JWT**: Access (15 mins) + Refresh (7 days)
- **MFA**: 敏感操作需驗證（共享可見性更新、能力旗標調整、批次匯出、席位認領確認）
- **Rate Limit**: 登入 5 次/分鐘/IP；共享查詢 30 次/分鐘/使用者（scope=shared），逾限回 429 並寫入審計
- **RLS**: PostgreSQL Row Level Security
  - 教練僅存取授課資料
  - 學生僅存取自身記錄
  - 監護人僅存取允許的學生
  - 共享紀錄需同時檢查 `share_visibility` 與 `can_view_shared_records`
- **審計**: 所有寫操作記錄 `audit_logs`，共享查詢與旗標調整必須附帶理由與操作者資訊

### 7.2 隱私
- **傳輸**: TLS 1.3
- **靜態加密**: AES-256 (學生聯絡方式、座位身份表單)
- **備份**: WAL + S3 (保留 30 天)
- **身份表單**: 認領完成後僅保留必要欄位（姓名、生日、Email），保險/備註可匿名化或定期清除
- **法規遵循**: GDPR/個資法

### 7.3 效能 SLO
- API P95 < 400ms
- 同時在線 500 用戶
- 資料備份 RTO < 4h, RPO < 1h
- Read Replica 服務報表查詢

---

## 🚀 8. 資料遷移計畫

### 8.1 遷移步驟
1. **v4 資料匯入**:
   - `resorts`, `users`, `lessons`, `order_seats`
   - `abilitylist.csv` → `ability_catalog`（依 `sport_type`、`skill_level`、`sequence_in_level` 分組 UPSERT）
   - `evaluationrecords_2425.csv` → 轉換為 `coach_ability_ratings`（拆解 `knew/familiar/excellent` 至 `proficiency_band`）+ `student_self_evaluations`

2. **學生身份統一**:
   - 建立 `global_students` (以 email/phone 去重)
   - 建立 `student_mappings` 連結雪場

3. **對照表建立**:
   - 舊系統 ID → 新系統 UUID 映射（含 `studentIdx`、`lessonIdx`）
   - 能力代碼一致性驗證（確保 CSV `idx` 與 DB `ability_catalog.id` 對齊）

4. **整合測試**:
   - 隨機抽樣 100 筆學生檢核星等與評語
   - 驗證席位認領、評量繼承流程

### 8.2 回滾方案
- 保留舊系統唯讀 30 天
- 遷移失敗時從備份恢復
- 提供「差異報告」供人工核對

---

## ⚠️ 9. 風險與緩解

| 風險 | 緩解策略 |
|------|----------|
| 資料遷移錯誤 | 分段遷移、抽樣驗證、保留舊系統 |
| 教練/學生習慣改變 | 導覽影片、Beta 測試、浮層說明 |
| 排序邏輯 bug | 後端統一處理、單元測試覆蓋 |
| 繼承深度過深 | Service 層檢查、可配置上限 |
| 監護人身份混亂 | UUID 邀請連結、不靠姓名匹配 |
| 安全控管疏漏 | 啟用 RLS、滲透測試、WAF |
| 報表效能 | Read Replica、索引、排程匯出 |

---

## 📝 10. 後續工作

### Phase 1 (MVP)
- [ ] 完成 ERD 與 OpenAPI 文件
- [ ] 前端 Wireframe (Figma)
- [ ] 資料庫遷移腳本
- [ ] 核心 API 開發 (教練記錄、評量、認領)
- [ ] Beta 測試 (5 位教練、20 位學生)

### Phase 2 (增強)
- [ ] 批次操作與模板
- [ ] 學生進度趨勢圖
- [ ] 字典維護後台
- [ ] 報表與匯出

### Phase 3 (優化)
- [ ] 進階報表與分析
- [ ] I18N 多語系
- [ ] Mobile App

---

## ✅ 11. Linus 原則檢查清單

### Good Taste ✅
- [x] 能力評量與教學過程分離 (`coach_ability_ratings` vs `lesson_detail_*`)
- [x] 排序由後端統一處理 (消除前端 `1..n` 特殊情況)
- [x] 單一職責：每個表只做一件事

### Never Break Userspace ✅
- [x] v4 舊資料完整遷移
- [x] 三星評等體系不變
- [x] API 向後相容 (新增不破壞)

### Pragmatism ✅
- [x] 解決真實問題 (教練記憶負擔、學生進度追蹤)
- [x] 繼承深度改為業務規則 (不是 DB 約束)
- [x] 監護人用 UUID (不靠三欄位匹配)

### Simplicity ✅
- [x] 最小可行架構
- [x] 避免多層縮排 (排序邏輯統一)
- [x] 消除過度設計 (繼承深度、position 連續性)

---

## 📚 附錄

### A. 名詞表
- **Outcome**: 能力評量的結果資料 (星等、評語)
- **Process**: 教學過程資料 (分析、練習、影片、摘要)
- **Mapping**: 全域學生映射到雪場或課程域的關係
- **繼承**: 沿用最近一次評量為基礎
- **P95**: 95 百分位回應時間指標
- **RLS**: Row Level Security (PostgreSQL 行級安全)

### B. 變更日誌

**v2.0 (2025-09-30)**:
- 🔧 簡化 position 邏輯 (後端自動編號)
- 🔧 簡化評量繼承 (移除 DB 深度約束)
- 🔧 簡化監護人流程 (UUID 為主)
- 📝 合併 sdd-T.md 與 sdd-T-spec.md
- 📝 移除重複內容

**v1.0 (2025-09-29)**:
- 初版規格 (sdd-T.md + sdd-T-spec.md)

---

**文檔維護**: 本文檔為唯一正式規格，其他文檔作為歷史參考。
**下次更新**: 加入日期時間到檔名 `sdd-T-spec_YYYYMMDD_HHMMSS.md`
