# 📚 SDD-T 文檔版本說明

## 🆕 最新版本 (2025-10-03 12:00) ⭐️

### ✅ 請使用這些文檔：

1. **主規格文件** (Human Readable)
   - `sdd-T-spec_20251002.md` ⭐️ **這是唯一正式規格**
   - 內容：完整系統規格、資料模型、API 設計、User Stories
   - 改進：收斂 `GET /lesson-records` 為單端點（scope/visibility）、新增共享查詢節流、補上 MFA+審計需求、`lesson_record_details` 冗餘 `resort_id` 與簽名 URL TTL 說明

2. **AI 開發約束** (Machine Readable)
   - `sdd-T-ai-constraints_20251001_094633.md`
   - 內容：AI 開發時必須遵循的核心約束、任務模板、完整 Schema 定義、共享查詢權限檢查（含 scope=private|shared 流程與 Rate Limit 規範）
   - 用途：給 Copilot/ChatGPT/自動化工具使用

---

## 📦 舊版文檔 (保留參考)

### 版本歷史：

**v2.3** (2025-10-03 12:00) - 當前最新版 ⭐️
- `sdd-T-spec_20251002.md`
- `sdd-T-ai-constraints_20251001_094633.md`
- 收斂教學紀錄列表為單一端點（scope=private|shared），共享結果回傳脫敏資料與 `expires_in`
- `lesson_record_details` 新增 `resort_id`、trigger 與共享索引；RLS 改以欄位對齊
- `can_view_shared_records` 預設 `FALSE`，旗標調整需 MFA + 審計；共享查詢加上 30 次/分鐘節流

**v2.2** (2025-10-02 11:05)
- `sdd-T-spec_20251001_094633.md`
- `sdd-T-ai-constraints_20251001_094633.md`
- 新增教學紀錄共享欄位、API、RLS、審計與監控指引
- 新增 `seat_identity_forms` 認領前身份流程與相關 API
- 管理員可控 `can_view_shared_records`，共享查詢須檢查權限

**v2.1** (2025-10-01 09:46)
- `sdd-T-spec_20251001_094633.md`
- `sdd-T-ai-constraints_20251001_094633.md`
- 修正：`display_order SERIAL` → `INTEGER`
- 補充：完整 Schema 定義到 AI 約束文件

**v2.0** (2025-09-30 20:52) - 重構版
- `sdd-T-spec_20250930_205208.md`
- `sdd-T-ai-constraints_20250930_205208.md`
- 合併重複文檔、簡化過度設計

**v1.0** (2025-09-29) - 原始版本
- `sdd-T.md` (學生×教練整合版)
- `sdd-T-spec.md` (正式規格，64KB)
- `sdd_t_steering_ai_instructions_v_1.md` (AI 指引)
- 問題：內容重複、SERIAL 誤用、過度設計

---

## 🔧 重構改進摘要

### 問題 1: 文件職責混亂 ✅ 已解決
- **舊狀況**: 兩份 90% 相同的規格文件
- **新設計**: 單一主規格 + AI 專用約束文件

### 問題 2: position 邏輯過於複雜 ✅ 已簡化
- **舊設計**: 前端傳 `position: 1, 2, 3...`，後端檢查連續性
- **新設計**: 後端維護 `display_order` INTEGER，由 Service 層重新編號，前端只傳 ID 陣列
- **補充**: 重排需比對 ID 集合並包在交易內，防漏寫造成亂序

### 問題 3: 評量繼承過度設計 ✅ 已簡化
- **舊設計**: DB 加 `inheritance_depth CHECK <= 2` 約束
- **新設計**: 單層 `source_rating_id` 引用，深度檢查在 Service 層
- **補充**: Service 層必須防循環引用並遵守可配置最大層數

### 問題 4: 監護人流程複雜 ✅ 已簡化
- **舊設計**: 用 `(guardian_email, student_name, birth_date)` 三欄位匹配
- **新設計**: UUID 邀請連結 `/invite/student/{uuid}?token={code}`
- **補充**: token 雜湊儲存、預設 7 天 TTL，成功認領即失效

### 問題 5: 席位狀態難以追蹤 ✅ 已標準化
- **舊狀況**: 沒有一致的狀態轉移，過期邀請碼不會自動回收
- **新設計**: 定義 `pending → invited → claimed/completed` 與 `expired` 流程，排程自動更新過期狀態
- **補充**: 排程記錄 `job_runs` 並發送告警，避免失敗無人知悉

### 問題 6: 業務錯誤碼與實作指引分散 ✅ 已統一
- **舊狀況**: 各功能自行決定錯誤訊息，缺乏跨語言指引
- **新設計**: 規格列出標準 BusinessError code（如 `ANALYSIS_SET_MISMATCH`、`INHERITANCE_INVALID_CHAIN`），並提供語言無關的 Service 層準則

### 問題 7: 教學紀錄缺乏共享控制 ✅ 已定義
- **舊狀況**: 舊系統僅能全量查詢，無開關與權限限制
- **新設計**: 新增 `share_visibility`（private/resort/all）與教練權限 `can_view_shared_records`，共享查詢需經審計與 RLS 驗證
- **最新補充 (2025-10-03)**: 收斂成單一列表端點（scope/visibility）、新增 `resort_id` 冗餘與索引、共享查詢加上 30 次/分鐘節流與簽名 URL TTL

### 問題 8: 認領流程缺乏身份資料 ✅ 已規劃
- **舊狀況**: 只有邀請連結 (UUID)，無法驗證學生/監護人是否拿錯
- **新設計**: 設計 `seat_identity_forms` 收集學生姓名/Email/生日，認領前必須完成並顯示確認資訊，可撤銷重填，與保險流程解耦

---

## 📖 使用指南

### 開發人員
1. 閱讀 `sdd-T-spec_20251002.md` 了解最新完整系統設計
2. 開發時參考 `sdd-T-ai-constraints_20251001_094633.md` 的核心約束
3. 遇到疑問時可查閱舊文檔歷史脈絡

### AI 工具
1. 載入 `sdd-T-ai-constraints_20251001_094633.md` 作為系統提示詞
2. 遵循其中的約束與模板
3. 輸出前使用「自我檢查清單」驗證

### 專案管理
1. 主規格作為唯一事實來源
2. 變更需更新主規格並加上新的時間戳版本
3. 舊版本文檔不刪除，作為歷史參考

---

## 🔄 版本命名規則

```
sdd-T-spec_YYYYMMDD[_HHMMSS].md
           ^^^^^^^^  ^^^^^^
           日期       （選填）時間

範例:
sdd-T-spec_20251002.md          # 2025年10月2日 12:00:00 發佈
sdd-T-spec_20251001_094633.md   # 2025年10月1日 09:46:33 發佈
```

**好處**:
- ✅ 一眼看出哪個是最新版 (數字越大越新)
- ✅ 不會搞混版本
- ✅ 可以追溯歷史變更
- ✅ 需要更細粒度時可加時間戳，否則以日期即可

---

## 🎯 何時建立新版本？

### ✅ 必須建新版本 (Major Change)
- **資料表結構變更** (新增/刪除欄位、改型別、改約束)
- **API 路徑或參數變更** (破壞性改動)
- **業務規則調整** (如繼承深度、評量規則、排序邏輯)
- **架構重構** (如權限模型、併發控制機制)
- **修正設計錯誤** (如 SERIAL 誤用、過度設計)

**操作**：建立新檔案 `sdd-T-spec_YYYYMMDD_HHMMSS.md`

### 📝 可不建新版本 (Minor Change)
- 修正錯字、標點符號
- 調整格式、排版
- 新增註解或使用範例
- 補充使用說明
- 更新待辦事項清單

**操作**：直接編輯最新版本

### 🔍 判斷標準

**問自己**：
1. 這個變更會影響開發者的實作嗎？ → 是 = Major
2. 這個變更會改變資料庫 Schema 嗎？ → 是 = Major
3. 這個變更會讓現有程式碼錯誤嗎？ → 是 = Major
4. 這個變更只是讓文件更清楚嗎？ → 是 = Minor

**範例**：
- ✅ Major: `display_order SERIAL` → `INTEGER` (影響實作)
- 📝 Minor: 補充「為什麼用 INTEGER」的說明 (不影響實作)

---

## 🚀 下一步（待確認優先順序）

- [ ] 建立 `api-contract.yaml` (OpenAPI 規格)
- [ ] 建立 `docs/erd.png` (ER Diagram)
- [ ] 建立 `docs/wireframes/` (前端設計稿)
- [ ] 建立 `migrations/` (資料庫遷移腳本)
- [ ] 實作邀請碼產生重試機制（最多 5 次，否則回傳 `INVITE_CODE_COLLISION`）
- [ ] 建立邀請碼過期清理排程（更新 seat 狀態為 `expired` 並回收記錄）
- [ ] 依 Service 層準則撰寫語言無關開發手冊（流程/時序/錯誤碼對照）
- [ ] 實作教學紀錄共享設定/查詢 API、前端開關與審計紀錄
- [ ] 管理員後台補上 `can_view_shared_records` 權限維護
- [x] 補足共享 API 的 `scope`/`visibility` 授權流程與脫敏策略
- [ ] 實作 `seat_identity_forms` 表單（後台 + 公開端點）與認領前驗證
- [ ] 邀請確認頁顯示身份資訊並允許撤銷重新填寫

---

**維護**: 每次重大設計變更時建立新版本，檔名加上時間戳。
**聯絡**: 有問題請查閱主規格或 AI 約束文件的「相關文檔」章節。
